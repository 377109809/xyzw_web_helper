import{k as Ce,c as g,i as d,a as e,J as fe,H as ge,r as G,o as ke,R as xe,p as I,v as me,f as te,d as u,l as de,t as f,y as se,w as m,j as V,F as pe,g as ye,D as Ie,b as ce,u as ne,K as je,s as Ge,G as qe,P as Ve,x as $e,B as Te,C as Qe,A as Je,S as Ke,U as Ye,e as Xe}from"./index-DAdUG7DC.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{R as Ae}from"./Refresh-iaXbz8yC.js";import{C as We}from"./Copy-CkpAEw-5.js";import{C as Re}from"./ChevronDown-DaoOvDzx.js";import{_ as Ze}from"./xiaoyugan-Dwisk7G8.js";import{S as et}from"./Settings-Bn_DVoU6.js";import{C as tt}from"./CheckmarkCircle-DtoX4Wwq.js";import{B as Le}from"./index-BoKBEZH9.js";const st={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},nt=e("path",{d:"M480 128a64 64 0 0 0-64-64h-16V48.45c0-8.61-6.62-16-15.23-16.43A16 16 0 0 0 368 48v16H144V48.45c0-8.61-6.62-16-15.23-16.43A16 16 0 0 0 112 48v16H96a64 64 0 0 0-64 64v12a4 4 0 0 0 4 4h440a4 4 0 0 0 4-4z",fill:"currentColor"},null,-1),at=e("path",{d:"M32 416a64 64 0 0 0 64 64h320a64 64 0 0 0 64-64V179a3 3 0 0 0-3-3H35a3 3 0 0 0-3 3zm344-208a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm0 80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm-80-80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm0 80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm0 80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm-80-80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm0 80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm-80-80a24 24 0 1 1-24 24a24 24 0 0 1 24-24zm0 80a24 24 0 1 1-24 24a24 24 0 0 1 24-24z",fill:"currentColor"},null,-1),ot=[nt,at],lt=Ce({name:"Calendar",render:function(s,a){return d(),g("svg",st,ot)}}),it={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},rt=e("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"48",d:"M112 328l144-144l144 144"},null,-1),ct=[rt],Ue=Ce({name:"ChevronUp",render:function(s,a){return d(),g("svg",it,ct)}}),ut={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},dt=e("path",{d:"M424.44 227.25a16 16 0 0 1-12.12-12.39c-7.68-36.68-24.45-68.15-49.18-92A153.57 153.57 0 0 0 256 80c-35.5 0-68.24 11.69-94.68 33.8a156.24 156.24 0 0 0-42 56a16 16 0 0 1-11.37 9.15c-27 5.62-51.07 17.34-69.18 33.87C13.39 235.88 0 267.42 0 304c0 36 14.38 68.88 40.49 92.59C65.64 419.43 99.56 432 136 432h260c32.37 0 60.23-8.57 80.59-24.77C499.76 388.78 512 361.39 512 328c0-57.57-42-90.58-87.56-100.75zm-95.2-8.94l-107.8 128a16 16 0 0 1-12 5.69h-.27a16 16 0 0 1-11.88-5.28l-45.9-50.87c-5.77-6.39-5.82-16.33.3-22.4a16 16 0 0 1 23.16.63l33.9 37.58l96-114a16 16 0 1 1 24.48 20.62z",fill:"currentColor"},null,-1),mt=[dt],vt=Ce({name:"CloudDone",render:function(s,a){return d(),g("svg",ut,mt)}}),pt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ft=e("path",{d:"M428 224H288a48 48 0 0 1-48-48V36a4 4 0 0 0-4-4h-92a64 64 0 0 0-64 64v320a64 64 0 0 0 64 64h224a64 64 0 0 0 64-64V228a4 4 0 0 0-4-4zm-92 160H176a16 16 0 0 1 0-32h160a16 16 0 0 1 0 32zm0-80H176a16 16 0 0 1 0-32h160a16 16 0 0 1 0 32z",fill:"currentColor"},null,-1),_t=e("path",{d:"M419.22 188.59L275.41 44.78a2 2 0 0 0-3.41 1.41V176a16 16 0 0 0 16 16h129.81a2 2 0 0 0 1.41-3.41z",fill:"currentColor"},null,-1),gt=[ft,_t],Ne=Ce({name:"DocumentText",render:function(s,a){return d(),g("svg",pt,gt)}}),ht={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},yt=e("circle",{cx:"256",cy:"256",r:"192",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),kt=[yt],bt=Ce({name:"EllipseOutline",render:function(s,a){return d(),g("svg",ht,kt)}}),wt="/icons/%E7%96%AF%E7%8B%82%E8%B5%9B%E8%BD%A6.png",$t={class:"status-card club-car-king"},Tt={class:"card-header"},Ct={class:"card-content"},St={class:"car-toolbar"},It={key:0,class:"hint"},xt={key:1,class:"hint"},Mt={key:2,class:"car-grid"},Dt={class:"car-header"},At=["src","alt"],Nt={class:"car-name"},zt={class:"car-meta"},Wt={class:"kv"},Rt={class:"v"},Ut={key:0,class:"kv"},Bt={class:"v"},Et={key:1,class:"kv"},Pt={class:"v"},Ht={class:"kv"},Ot={class:"v"},Lt={class:"kv"},Ft={class:"v"},jt={key:2,class:"kv"},Gt={class:"car-actions"},qt={class:"helper-body"},Vt={class:"helper-row"},Be=4*60*60*1e3,Qt={__name:"ClubCarKing",setup(J){const s=fe(),a=ge(),o=G(!1),l=G(null),_=G(!1),T=G(0),B=G(Date.now());let $=null;ke(()=>{$=setInterval(()=>{B.value=Date.now()},6e4)}),xe(()=>{$&&clearInterval($)});const S=I(()=>new Date(B.value).getHours()>=20),A=I(()=>{const n=new Date(B.value).getDay();return n>=1&&n<=3}),k=I(()=>{const r=s.selectedToken;return r?s.getWebSocketStatus(r.id)==="connected":!1}),R=r=>{const n=r||{},w=n.body||n,M=w.roleCar||w.rolecar||{},H=M.carDataMap||M.cardatamap;if(H&&typeof H=="object")return Object.entries(H).map(([oe,W],re)=>({key:re,id:oe,...W||{}}));let F=w.cars||w.list||w.data||w.carList||w.vehicles||[];return!Array.isArray(F)&&typeof F=="object"&&F!==null&&(F=Object.values(F)),Array.isArray(w)&&F.length===0&&(F=w),(Array.isArray(F)?F:[]).map((oe,W)=>({key:W,...oe}))},h=I(()=>R(l.value)),y=I(()=>(h.value||[]).filter(r=>Number(r.refreshCount??0)===0).length),E=I(()=>y.value>0),q=r=>({1:"绿·普通",2:"蓝·稀有",3:"紫·史诗",4:"橙·传说",5:"红·神话",6:"金·传奇"})[r]||"未知",D=r=>({1:"/icons/大众.svg",2:"/icons/特斯拉.svg",3:"/icons/奥迪.svg",4:"/icons/奔驰.svg",5:"/icons/保时捷.svg",6:"/icons/兰博基尼.svg"})[r]||"/icons/大众.svg",C=r=>{const n=[{type:3,itemId:3201,value:10},{type:3,itemId:1001,value:10},{type:3,itemId:1022,value:2e3},{type:2,itemId:0,value:2e3},{type:3,itemId:1023,value:5},{type:3,itemId:1022,value:2500},{type:3,itemId:1001,value:12}];return Array.isArray(r)?n.some(w=>r.find(M=>M.type===w.type&&M.itemId===w.itemId&&Number(M.value||0)>=w.value)):!1},v=r=>Array.isArray(r)?r.reduce((n,w)=>n+(w.type===3&&w.itemId===35002?Number(w.value||0):0),0):0,b=(r,n)=>{const w=Number((r==null?void 0:r.color)||0),M=Array.isArray(r==null?void 0:r.rewards)?r.rewards:[],H=v(M);return n>=6?w>=5||H>=4||C(M):w>=4||H>=2||C(M)},x=async()=>{var n,w,M;const r=s.selectedToken;if(!r||!k.value){a.warning("请先选择 Token 并建立连接");return}o.value=!0;try{const H=await s.sendMessageWithPromise(r.id,"car_getrolecar",{},1e4);try{const F=await s.sendMessageWithPromise(r.id,"role_getroleinfo",{},1e4),oe=(M=(w=(n=F==null?void 0:F.role)==null?void 0:n.items)==null?void 0:w[35002])==null?void 0:M.quantity;T.value=Number(oe||0)}catch{}l.value=(H==null?void 0:H.body)??H,_.value=!0,R(l.value).length?a.success("疯狂赛车数据已更新"):a.info("未识别到车辆字段，已启用智能解析。如仍为空请提供返回示例")}catch(H){a.error("获取车辆数据失败："+(H.message||"未知错误"))}finally{o.value=!1}};me(k,r=>{r&&!_.value&&x()});const z=async r=>{var w,M,H,F,oe;const n=s.selectedToken;if(!n||!k.value){a.warning("请先选择 Token 并建立连接");return}if(!(r!=null&&r.id)){a.warning("未找到车辆ID");return}if(Number(r.sendAt||0)!==0){a.warning("仅未发车的车辆可刷新品阶");return}try{Number(r.refreshCount??0)!==0&&a.info("将消耗车票进行刷新");const W=await s.sendMessageWithPromise(n.id,"car_refresh",{carId:String(r.id)},1e4),re=(W==null?void 0:W.car)||((w=W==null?void 0:W.body)==null?void 0:w.car)||W;if(re&&typeof re=="object"){if(re.color!=null&&(r.color=Number(re.color)),re.refreshCount!=null){r.refreshCount=Number(re.refreshCount);const De=((M=l.value)==null?void 0:M.body)||l.value||{};De.roleCar&&De.roleCar.refreshCount!=null&&(De.roleCar.refreshCount=Number(re.refreshCount))}const Se=q(r.color);a.success(`刷新完成：${Se}`)}else await x(),a.success("品阶刷新完成");try{const Se=await s.sendMessageWithPromise(n.id,"role_getroleinfo",{},8e3);T.value=Number(((oe=(F=(H=Se==null?void 0:Se.role)==null?void 0:H.items)==null?void 0:F[35002])==null?void 0:oe.quantity)||0)}catch{}}catch(W){a.error("刷新失败："+(W.message||"未知错误"))}},U=async r=>{var w;const n=s.selectedToken;if(!n||!k.value){a.warning("请先选择 Token 并建立连接");return}if(Number(r.sendAt||0)!==0){a.info("该车辆已发车");return}if(!A.value){a.warning("非活动时间不可发车（仅周一至周三开放）");return}if(!(r!=null&&r.id)){a.warning("未找到车辆ID");return}if(Number(r.sendAt||0)!==0){a.info("该车辆已发车");return}try{a.info("发车中...");const M=await s.sendMessageWithPromise(n.id,"car_send",{carId:String(r.id),helperId:Number(r.helperId||0),text:"",isUpgrade:!1},1e4),H=(M==null?void 0:M.body)||M,F=(H==null?void 0:H.roleCar)||(H==null?void 0:H.rolecar),oe=(F==null?void 0:F.carDataMap)||(F==null?void 0:F.cardatamap);if(oe&&oe[r.id]){const W=oe[r.id],re=((w=l.value)==null?void 0:w.body)||l.value||{};re.roleCar&&re.roleCar.carDataMap&&re.roleCar.carDataMap[r.id]&&(re.roleCar.carDataMap[r.id]={...re.roleCar.carDataMap[r.id],...W}),W.sendAt!=null&&(r.sendAt=W.sendAt),W.color!=null&&(r.color=W.color),W.refreshCount!=null&&(r.refreshCount=W.refreshCount),a.success("已发车")}else await x(),a.success("已发车")}catch(M){a.error("发车失败："+(M.message||"未知错误"))}},O=r=>{const n=Number((r==null?void 0:r.sendAt)||0);if(!n)return!1;const w=n<1e12?n*1e3:n;return B.value-w>=Be},le=async r=>{var w;const n=s.selectedToken;if(!n||!k.value)return a.warning("请先选择 Token 并建立连接");if(!(r!=null&&r.id))return a.warning("未找到车辆ID");if(!O(r))return a.warning("未到可收车时间（需超过4小时）");try{a.info("收车中...");const M=await s.sendMessageWithPromise(n.id,"car_claim",{carId:String(r.id)},1e4);r.sendAt=0;const H=((w=l.value)==null?void 0:w.body)||l.value||{};H.roleCar&&H.roleCar.carDataMap&&H.roleCar.carDataMap[r.id]&&(H.roleCar.carDataMap[r.id]={...H.roleCar.carDataMap[r.id],sendAt:0}),a.success("收车完成")}catch(M){a.error("收车失败："+(M.message||"未知错误"))}},ie=r=>{const n=Number((r==null?void 0:r.sendAt)||0);return n?(n<1e12?n*1e3:n)+Be-B.value:0},Z=r=>{if(r<=0)return"0分";const n=Math.ceil(r/1e3),w=Math.floor(n/3600),M=Math.floor(n%3600/60);return w>0?`${w}小时${M}分`:`${M}分`},L=r=>Number((r==null?void 0:r.sendAt)||0)!==0?O(r)?"收车":`收车(剩余${Z(ie(r))})`:"发车",ae=r=>Number((r==null?void 0:r.sendAt)||0)!==0?!O(r):S.value||!A.value,Q=async r=>{if(!(Number((r==null?void 0:r.sendAt)||0)!==0))return U(r);if(O(r))return le(r);{const w=Z(ie(r));a.info(`未到可收车时间，剩余 ${w}`)}},P=async()=>{if(!s.selectedToken||!k.value)return a.warning("请先选择 Token 并建立连接");try{const n=(h.value||[]).filter(w=>O(w));for(const w of n){try{await le(w)}catch{}await new Promise(M=>setTimeout(M,300))}await x(),a.success("一键收车完成")}catch(n){a.error("一键收车失败："+(n.message||"未知错误"))}},i=async()=>{if(!s.selectedToken||!k.value)return a.warning("请先选择 Token 并建立连接");try{await x();let n=Number(T.value||0);for(const w of h.value){if(Number(w.sendAt||0)!==0)continue;if(b(w,n)){await U(w),await new Promise(F=>setTimeout(F,500));continue}let M=!1;const H=Number(w.refreshCount??0)===0;if(n>=6)M=!0;else if(H)M=!0;else{await U(w),await new Promise(F=>setTimeout(F,500));continue}for(;M;){if(await z(w),n=Number(T.value||0),b(w,n)){await U(w),await new Promise(oe=>setTimeout(oe,500));break}const F=Number(w.refreshCount??0)===0;if(n>=6)M=!0;else if(F)M=!0;else{await U(w),await new Promise(oe=>setTimeout(oe,500));break}}}await x(),a.success("智能发车完成")}catch(n){a.error("智能发车失败："+(n.message||"未知错误"))}},t=G(!1),p=G(!1),c=G([]),j=G(null),Y=G(null),X=I(()=>{var r;return((r=s.gameData)==null?void 0:r.legionInfo)||null}),ee=I(()=>{var r;return((r=X.value)==null?void 0:r.info)||{}}),N=I(()=>{var r;return((r=ee.value)==null?void 0:r.members)||{}}),K=I(()=>Object.values(N.value||{})),ue=async r=>{var w;const n=s.selectedToken;if(!n||!k.value)return a.warning("请先选择 Token 并建立连接");if(Number(r.color||0)<5)return a.warning("仅品阶≥5的车辆可设置护卫");if(Number(r.sendAt||0)!==0)return a.warning("已发车车辆不可设置护卫");Y.value=r,t.value=!0,p.value=!0,j.value=r.helperId?String(r.helperId):null;try{const M=await s.sendMessageWithPromise(n.id,"car_getmemberhelpingcnt",{},1e4),H=((w=M==null?void 0:M.body)==null?void 0:w.memberHelpingCntMap)||(M==null?void 0:M.memberHelpingCntMap)||{},F=K.value.map(oe=>{const W=String(oe.roleId),re=Number(H[W]??0);return{label:`${oe.name||oe.nickname||W}（已护卫 ${re}/4）`,value:W,disabled:re>=4}});c.value=F}catch(M){a.error("获取护卫数据失败："+(M.message||"未知错误")),c.value=[]}finally{p.value=!1}},ve=()=>{Y.value&&(Y.value.helperId=j.value?String(j.value):null),t.value=!1},_e=()=>{t.value=!1};return(r,n)=>{const w=te("n-button"),M=te("n-tag"),H=te("n-space"),F=te("n-select"),oe=te("n-modal");return d(),g(pe,null,[e("div",$t,[e("div",Tt,[n[3]||(n[3]=e("img",{class:"status-icon",src:wt,alt:"疯狂赛车"},null,-1)),n[4]||(n[4]=e("div",{class:"status-info"},[e("h3",null,"疯狂赛车"),e("p",null,"车辆仓库与品阶")],-1)),e("div",{class:de(["status-badge",{active:h.value.length>0}])},[n[2]||(n[2]=e("div",{class:"status-dot"},null,-1)),e("span",null,f(h.value.length>0?`共 ${h.value.length} 辆`:"暂无数据"),1)],2)]),e("div",Ct,[e("div",St,[u(H,{size:"small"},{default:m(()=>[u(w,{type:"primary",size:"small",loading:o.value,onClick:x},{default:m(()=>[V(f(o.value?"加载中...":"刷新数据"),1)]),_:1},8,["loading"]),u(w,{size:"small",secondary:"",disabled:o.value||!k.value,onClick:i},{default:m(()=>[...n[5]||(n[5]=[V("智能发车",-1)])]),_:1},8,["disabled"]),u(w,{size:"small",secondary:"",disabled:o.value||!k.value,onClick:P},{default:m(()=>[...n[6]||(n[6]=[V("一键收车",-1)])]),_:1},8,["disabled"]),u(M,{size:"small",type:E.value?"success":"default"},{default:m(()=>[V(f(E.value?`有 ${y.value} 辆可免费刷新`:"无免费刷新"),1)]),_:1},8,["type"]),u(M,{size:"small",type:"info"},{default:m(()=>[V("剩余车票: "+f(T.value),1)]),_:1})]),_:1})]),k.value?h.value.length===0&&!o.value?(d(),g("div",xt,"暂无车辆数据")):se("",!0):(d(),g("div",It,"请先选择 Token 并建立连接")),h.value.length>0?(d(),g("div",Mt,[(d(!0),g(pe,null,ye(h.value,W=>(d(),g("div",{key:W.key,class:"car-card"},[e("div",Dt,[e("img",{class:"car-brand-icon",src:D(W.color),alt:q(W.color)},null,8,At),e("div",{class:de(["car-badge","grade-"+(W.color||0)])},f(q(W.color)),3),e("div",Nt,f(W.name||W.carName||"车辆 #"+(W.id||W.key)),1)]),e("div",zt,[e("div",Wt,[n[7]||(n[7]=e("span",{class:"k"},"品阶",-1)),e("span",Rt,[e("span",{class:de(["grade-dot","grade-"+(W.color||0)])},null,2),V(f(q(W.color)),1)])]),W.level!=null?(d(),g("div",Ut,[n[8]||(n[8]=e("span",{class:"k"},"等级",-1)),e("span",Bt,f(W.level),1)])):se("",!0),W.star!=null?(d(),g("div",Et,[n[9]||(n[9]=e("span",{class:"k"},"星级",-1)),e("span",Pt,f(W.star),1)])):se("",!0),e("div",Ht,[n[10]||(n[10]=e("span",{class:"k"},"状态",-1)),e("span",Ot,f(Number(W.sendAt||0)===0?"未发车":"已发车"),1)]),e("div",Lt,[n[11]||(n[11]=e("span",{class:"k"},"帮手",-1)),e("span",Ft,f(Number(W.color||0)>=5?"可携带":"—"),1)]),C(W.rewards)?(d(),g("div",jt,[...n[12]||(n[12]=[e("span",{class:"k"},"奖励",-1),e("span",{class:"v",style:{color:"#f59e0b"}},"包含大奖",-1)])])):se("",!0)]),e("div",Gt,[u(w,{size:"small",type:Number(W.refreshCount??0)===0?"success":"warning",disabled:o.value||Number(W.sendAt||0)!==0,onClick:re=>z(W)},{default:m(()=>[V(f(Number(W.refreshCount??0)===0?"免费刷新品阶":"刷新品阶(需车票)"),1)]),_:2},1032,["type","disabled","onClick"]),u(w,{size:"small",type:"primary",disabled:o.value||ae(W),onClick:re=>Q(W)},{default:m(()=>[V(f(L(W)),1)]),_:2},1032,["disabled","onClick"]),u(w,{size:"small",quaternary:"",disabled:o.value||Number(W.color||0)<5||Number(W.sendAt||0)!==0,onClick:re=>ue(W)},{default:m(()=>[...n[13]||(n[13]=[V(" 护卫 ",-1)])]),_:1},8,["disabled","onClick"])])]))),128))])):se("",!0)])]),u(oe,{show:t.value,"onUpdate:show":n[1]||(n[1]=W=>t.value=W),preset:"card",title:"选择护卫",style:{width:"520px"}},{footer:m(()=>[u(H,null,{default:m(()=>[u(w,{onClick:_e},{default:m(()=>[...n[16]||(n[16]=[V("取消",-1)])]),_:1}),u(w,{type:"primary",onClick:ve},{default:m(()=>[...n[17]||(n[17]=[V("确定",-1)])]),_:1})]),_:1})]),default:m(()=>[e("div",qt,[e("div",Vt,[n[14]||(n[14]=e("span",{class:"label"},"护卫成员",-1)),u(F,{value:j.value,"onUpdate:value":n[0]||(n[0]=W=>j.value=W),options:c.value,placeholder:"选择俱乐部成员",loading:p.value,filterable:"",style:{width:"320px"}},null,8,["value","options","loading"])]),n[15]||(n[15]=e("div",{class:"tips"},"说明：次数满 4 的成员不可再被选择。",-1))])]),_:1},8,["show"])],64)}}},Jt=he(Qt,[["__scopeId","data-v-86823775"]]),Kt={class:"status-card"},Yt={class:"card-header"},Xt={class:"status-icon"},Zt={class:"status-title"},es={class:"card-content"},Me=Ce({__name:"MyCard",props:{statusClass:{}},setup(J){return(s,a)=>(d(),g("div",Kt,[e("div",Yt,[e("div",Xt,[Ie(s.$slots,"icon")]),e("div",Zt,[Ie(s.$slots,"title")]),e("div",{class:de(["status-badge",J.statusClass])},[a[0]||(a[0]=e("div",{class:"status-dot"},null,-1)),Ie(s.$slots,"badge")],2),Ie(s.$slots,"extra")]),e("div",es,[Ie(s.$slots,"default")]),e("div",{class:de(["card-action",J.statusClass])},[Ie(s.$slots,"action")],2)]))}}),ts="/icons/1733492491706152.png";function ss(){const J=new Date,s=J.getDay();let a=0;s===6?a=0:s===0?a=1:a=s+1;const o=new Date(J);o.setDate(J.getDate()-a);const l=o.getFullYear(),_=String(o.getMonth()+1).padStart(2,"0"),T=String(o.getDate()).padStart(2,"0");return`${l}/${_}/${T}`}function Ee(J){const s=new Date(J*1e3),a=String(s.getMonth()+1).padStart(2,"0"),o=String(s.getDate()).padStart(2,"0"),l=String(s.getHours()).padStart(2,"0"),_=String(s.getMinutes()).padStart(2,"0"),T=String(s.getSeconds()).padStart(2,"0");return`${a}-${o} ${l}:${_}:${T}`}function Pe(J){return J===2?"胜利":"失败"}function He(J){return J===0?"进攻":"防守"}function ns(J,s){if(!J||J.length===0)return"暂无战绩数据";const a=[`俱乐部盐场战绩 - ${s}`,`参战人数: ${J.length}`,"─".repeat(40),""],o=[...J].sort((B,$)=>($.winCnt||0)-(B.winCnt||0));let l=0,_=0,T=0;return o.forEach((B,$)=>{const{name:S,winCnt:A,loseCnt:k,buildingCnt:R}=B;l+=A||0,_+=k||0,T+=R||0,a.push(`${$+1}. ${S}  击杀${A||0}  死亡${k||0}  攻城${R||0}`)}),a.push(""),a.push("─".repeat(40)),a.push(`总计  击杀${l}  死亡${_}  攻城${T}`),a.push(""),a.push(`导出时间: ${new Date().toLocaleString("zh-CN")}`),a.join(`
`)}async function as(J){if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(J);else{const s=document.createElement("textarea");s.value=J,s.style.position="fixed",s.style.left="-999999px",s.style.top="-999999px",document.body.appendChild(s),s.focus(),s.select();try{document.execCommand("copy")}catch{throw new Error("复制失败")}finally{s.remove()}}}const os={key:0,class:"inline-wrapper"},ls={class:"inline-header"},is={class:"header-actions"},rs={class:"battle-records-content"},cs={key:0,class:"loading-state"},us={key:1,class:"records-list"},ds={class:"records-info"},ms={class:"member-header"},vs={class:"member-info"},ps=["src","alt"],fs={key:1,class:"member-avatar-placeholder"},_s={class:"member-name"},gs={class:"member-stats-inline"},hs={class:"stat-inline win"},ys={class:"stat-inline loss"},ks={class:"stat-inline siege"},bs={class:"battle-details"},ws={key:0,class:"battles-list"},$s={class:"battle-participants"},Ts={class:"participant attacker"},Cs=["src","alt"],Ss={class:"participant-name"},Is={class:"battle-vs"},xs={class:"participant defender"},Ms=["src","alt"],Ds={class:"participant-name"},As={class:"battle-time"},Ns={key:1,class:"no-battles"},zs={key:2,class:"empty-state"},Ws={class:"header-actions"},Rs={class:"battle-records-content"},Us={key:0,class:"loading-state"},Bs={key:1,class:"records-list"},Es={class:"records-info"},Ps={class:"member-header"},Hs={class:"member-info"},Os=["src","alt"],Ls={key:1,class:"member-avatar-placeholder"},Fs={class:"member-name"},js={class:"member-stats-inline"},Gs={class:"stat-inline win"},qs={class:"stat-inline loss"},Vs={class:"stat-inline siege"},Qs={class:"battle-details"},Js={key:0,class:"battles-list"},Ks={class:"battle-participants"},Ys={class:"participant attacker"},Xs=["src","alt"],Zs={class:"participant-name"},en={class:"battle-vs"},tn={class:"participant defender"},sn=["src","alt"],nn={class:"participant-name"},an={class:"battle-time"},on={key:1,class:"no-battles"},ln={key:2,class:"empty-state"},rn={__name:"ClubBattleRecords",props:{visible:{type:Boolean,default:!1},inline:{type:Boolean,default:!1}},emits:["update:visible"],setup(J,{expose:s,emit:a}){const o=J,l=a,_=ge(),T=fe(),B=I({get:()=>o.visible,set:v=>l("update:visible",v)}),$=G(!1),S=G(null),A=G(new Set),k=G("");G({isRegistered:!1});const R=v=>{const b=[];return v.newWinFlag===2?b.push("battle-win"):b.push("battle-loss"),v.attackType===0?b.push("battle-attack"):b.push("battle-defend"),b.join(" ")},h=v=>{A.value.has(v)?A.value.delete(v):A.value.add(v)},y=v=>{v.target.style.display="none"},E=async()=>{if(!T.selectedToken){_.warning("请先选择游戏角色");return}const v=T.selectedToken.id;if(T.getWebSocketStatus(v)!=="connected"){_.error("WebSocket未连接，无法查询战绩");return}$.value=!0,k.value=ss();try{const x=await T.sendMessageWithPromise(v,"legionwar_getdetails",{date:k.value},1e4);x&&x.roleDetailsList?(S.value=x,_.success("战绩加载成功")):(S.value=null,_.warning("未查询到战绩数据"))}catch(x){console.error("查询战绩失败:",x),_.error(`查询失败: ${x.message}`),S.value=null}finally{$.value=!1}},q=()=>{E()},D=async()=>{if(!S.value||!S.value.roleDetailsList){_.warning("没有可导出的数据");return}try{const v=ns(S.value.roleDetailsList,k.value);await as(v),_.success("战绩已复制到剪贴板")}catch(v){console.error("导出失败:",v),_.error("导出失败，请重试")}},C=()=>{A.value.clear()};return s({fetchBattleRecords:E}),ke(()=>{o.inline&&E()}),(v,b)=>{const x=te("n-icon"),z=te("n-button"),U=te("n-spin"),O=te("n-tag"),le=te("n-empty"),ie=te("n-collapse-transition"),Z=te("n-modal");return d(),g("div",null,[J.inline?(d(),g("div",os,[e("div",ls,[b[3]||(b[3]=e("div",{class:"inline-title"},"俱乐部盐场战绩",-1)),e("div",is,[u(z,{size:"small",disabled:$.value,onClick:q},{icon:m(()=>[u(x,null,{default:m(()=>[u(ne(Ae))]),_:1})]),default:m(()=>[b[1]||(b[1]=V(" 刷新 ",-1))]),_:1},8,["disabled"]),u(z,{type:"primary",size:"small",disabled:!S.value||$.value,onClick:D},{icon:m(()=>[u(x,null,{default:m(()=>[u(ne(We))]),_:1})]),default:m(()=>[b[2]||(b[2]=V(" 导出 ",-1))]),_:1},8,["disabled"])])]),e("div",rs,[$.value?(d(),g("div",cs,[u(U,{size:"large"},{description:m(()=>[...b[4]||(b[4]=[V("正在加载战绩数据...",-1)])]),_:1})])):S.value&&S.value.roleDetailsList?(d(),g("div",us,[e("div",ds,[u(O,{type:"info"},{default:m(()=>[V("查询日期: "+f(k.value),1)]),_:1}),u(O,{type:"success"},{default:m(()=>[V("总成员: "+f(S.value.roleDetailsList.length),1)]),_:1})]),(d(!0),g(pe,null,ye(S.value.roleDetailsList,L=>{var ae;return d(),g("div",{key:L.roleId,class:"member-card"},[e("div",ms,[e("div",vs,[L.headImg?(d(),g("img",{key:0,src:L.headImg,alt:L.name,class:"member-avatar",onError:y},null,40,ps)):(d(),g("div",fs,f(((ae=L.name)==null?void 0:ae.charAt(0))||"?"),1)),e("span",_s,f(L.name),1)]),e("div",gs,[e("span",hs,"击杀 "+f(L.winCnt||0),1),e("span",ys,"死亡 "+f(L.loseCnt||0),1),e("span",ks,"攻城 "+f(L.buildingCnt||0),1)]),u(z,{text:"",size:"small",class:"details-button",onClick:Q=>h(L.roleId)},{icon:m(()=>[u(x,null,{default:m(()=>[A.value.has(L.roleId)?(d(),ce(ne(Ue),{key:1})):(d(),ce(ne(Re),{key:0}))]),_:2},1024)]),_:2},1032,["onClick"])]),u(ie,{show:A.value.has(L.roleId)},{default:m(()=>[e("div",bs,[L.targetRoleList&&L.targetRoleList.length>0?(d(),g("div",ws,[(d(!0),g(pe,null,ye(L.targetRoleList,(Q,P)=>{var i,t,p,c;return d(),g("div",{key:P,class:de(["battle-item",R(Q)])},[e("div",$s,[e("div",Ts,[(i=Q.roleInfo)!=null&&i.headImg?(d(),g("img",{key:0,src:Q.roleInfo.headImg,alt:Q.roleInfo.name,class:"participant-avatar",onError:y},null,40,Cs)):se("",!0),e("span",Ss,f(((t=Q.roleInfo)==null?void 0:t.name)||"未知"),1)]),e("div",Is,[u(O,{type:Q.attackType===0?"warning":"info",size:"small"},{default:m(()=>[V(f(ne(He)(Q.attackType)),1)]),_:2},1032,["type"]),u(O,{type:Q.newWinFlag===2?"success":"error",size:"small"},{default:m(()=>[V(f(ne(Pe)(Q.newWinFlag)),1)]),_:2},1032,["type"])]),e("div",xs,[(p=Q.targetRoleInfo)!=null&&p.headImg?(d(),g("img",{key:0,src:Q.targetRoleInfo.headImg,alt:Q.targetRoleInfo.name,class:"participant-avatar",onError:y},null,40,Ms)):se("",!0),e("span",Ds,f(((c=Q.targetRoleInfo)==null?void 0:c.name)||"未知"),1)])]),e("div",As,f(ne(Ee)(Q.timestamp)),1)],2)}),128))])):(d(),g("div",Ns,[u(le,{description:"暂无战斗记录",size:"small"})]))])]),_:2},1032,["show"])])}),128))])):(d(),g("div",zs,[u(le,{description:"暂无战绩数据",size:"large"},{icon:m(()=>[u(x,null,{default:m(()=>[u(ne(Ne))]),_:1})]),_:1})]))])])):(d(),ce(Z,{key:1,show:B.value,"onUpdate:show":b[0]||(b[0]=L=>B.value=L),preset:"card",title:"俱乐部盐场战绩",style:{width:"90%","max-width":"800px"},onAfterLeave:C},{"header-extra":m(()=>[e("div",Ws,[u(z,{size:"small",disabled:$.value,onClick:q},{icon:m(()=>[u(x,null,{default:m(()=>[u(ne(Ae))]),_:1})]),default:m(()=>[b[5]||(b[5]=V(" 刷新 ",-1))]),_:1},8,["disabled"]),u(z,{type:"primary",size:"small",disabled:!S.value||$.value,onClick:D},{icon:m(()=>[u(x,null,{default:m(()=>[u(ne(We))]),_:1})]),default:m(()=>[b[6]||(b[6]=V(" 导出 ",-1))]),_:1},8,["disabled"])])]),default:m(()=>[e("div",Rs,[$.value?(d(),g("div",Us,[u(U,{size:"large"},{description:m(()=>[...b[7]||(b[7]=[V("正在加载战绩数据...",-1)])]),_:1})])):S.value&&S.value.roleDetailsList?(d(),g("div",Bs,[e("div",Es,[u(O,{type:"info"},{default:m(()=>[V("查询日期: "+f(k.value),1)]),_:1}),u(O,{type:"success"},{default:m(()=>[V("总成员: "+f(S.value.roleDetailsList.length),1)]),_:1})]),(d(!0),g(pe,null,ye(S.value.roleDetailsList,L=>{var ae;return d(),g("div",{key:L.roleId,class:"member-card"},[e("div",Ps,[e("div",Hs,[L.headImg?(d(),g("img",{key:0,src:L.headImg,alt:L.name,class:"member-avatar",onError:y},null,40,Os)):(d(),g("div",Ls,f(((ae=L.name)==null?void 0:ae.charAt(0))||"?"),1)),e("span",Fs,f(L.name),1)]),e("div",js,[e("span",Gs,"击杀 "+f(L.winCnt||0),1),e("span",qs,"死亡 "+f(L.loseCnt||0),1),e("span",Vs,"攻城 "+f(L.buildingCnt||0),1)]),u(z,{text:"",size:"small",class:"details-button",onClick:Q=>h(L.roleId)},{icon:m(()=>[u(x,null,{default:m(()=>[A.value.has(L.roleId)?(d(),ce(ne(Ue),{key:1})):(d(),ce(ne(Re),{key:0}))]),_:2},1024)]),_:2},1032,["onClick"])]),u(ie,{show:A.value.has(L.roleId)},{default:m(()=>[e("div",Qs,[L.targetRoleList&&L.targetRoleList.length>0?(d(),g("div",Js,[(d(!0),g(pe,null,ye(L.targetRoleList,(Q,P)=>{var i,t,p,c;return d(),g("div",{key:P,class:de(["battle-item",R(Q)])},[e("div",Ks,[e("div",Ys,[(i=Q.roleInfo)!=null&&i.headImg?(d(),g("img",{key:0,src:Q.roleInfo.headImg,alt:Q.roleInfo.name,class:"participant-avatar",onError:y},null,40,Xs)):se("",!0),e("span",Zs,f(((t=Q.roleInfo)==null?void 0:t.name)||"未知"),1)]),e("div",en,[u(O,{type:Q.attackType===0?"warning":"info",size:"small"},{default:m(()=>[V(f(ne(He)(Q.attackType)),1)]),_:2},1032,["type"]),u(O,{type:Q.newWinFlag===2?"success":"error",size:"small"},{default:m(()=>[V(f(ne(Pe)(Q.newWinFlag)),1)]),_:2},1032,["type"])]),e("div",tn,[(p=Q.targetRoleInfo)!=null&&p.headImg?(d(),g("img",{key:0,src:Q.targetRoleInfo.headImg,alt:Q.targetRoleInfo.name,class:"participant-avatar",onError:y},null,40,sn)):se("",!0),e("span",nn,f(((c=Q.targetRoleInfo)==null?void 0:c.name)||"未知"),1)])]),e("div",an,f(ne(Ee)(Q.timestamp)),1)],2)}),128))])):(d(),g("div",on,[u(le,{description:"暂无战斗记录",size:"small"})]))])]),_:2},1032,["show"])])}),128))])):(d(),g("div",ln,[u(le,{description:"暂无战绩数据",size:"large"},{icon:m(()=>[u(x,null,{default:m(()=>[u(ne(Ne))]),_:1})]),_:1})]))])]),_:1},8,["show"]))])}}},cn=he(rn,[["__scopeId","data-v-baffdadd"]]),un={key:0,class:"empty-club"},dn={class:"actions"},mn={key:1},vn={class:"toolbar"},pn={class:"overview"},fn={class:"club-header"},_n={class:"meta"},gn={class:"name"},hn={class:"sub"},yn={class:"overview-actions"},kn={class:"grid"},bn={class:"item"},wn={class:"value"},$n={class:"item"},Tn={class:"value"},Cn={class:"item"},Sn={class:"value"},In={class:"item"},xn={class:"value"},Mn={key:0,class:"announcement"},Dn={class:"text"},An={key:1,class:"leader"},Nn={class:"leader-info"},zn={class:"leader-name"},Wn={class:"members"},Rn={class:"members-list"},Un={class:"left"},Bn={class:"name"},En={class:"right"},Pn={class:"power"},Hn={class:"tag"},On={key:0,class:"hint"},Ln={__name:"ClubInfo",setup(J){const s=fe(),a=ge(),o=I(()=>{var D;return((D=s.gameData)==null?void 0:D.legionInfo)||null}),l=I(()=>{var D;return((D=o.value)==null?void 0:D.info)||null}),_=I(()=>{var D;return((D=l.value)==null?void 0:D.members)||{}}),T=I(()=>Object.values(_.value||{})),B=I(()=>T.value.length),$=I(()=>{var C;const D=(C=l.value)==null?void 0:C.leaderId;return D&&T.value.find(v=>Number(v.roleId)===Number(D))||null}),S=I(()=>[...T.value].sort((D,C)=>{var v,b;return Number(C.power||((v=C.custom)==null?void 0:v.s_power)||0)-Number(D.power||((b=D.custom)==null?void 0:b.s_power)||0)}).slice(0,20)),A=G("overview"),k=I(()=>{var b,x,z,U;const D=Number(((U=(z=(x=(b=s.gameData)==null?void 0:b.roleInfo)==null?void 0:x.role)==null?void 0:z.statisticsTime)==null?void 0:U["legion:sign:in"])||0),C=new Date;C.setHours(0,0,0,0);const v=Math.floor(C.getTime()/1e3);return D>v}),R=()=>{const D=s.selectedToken;!D||k.value||(s.sendMessage(D.id,"legion_signin"),s.sendMessage(D.id,"role_getroleinfo"),a.info("俱乐部签到"))},h=I(()=>{const D=o.value||{},C=D.info||{},v=D.statistics||D.stat||{},b=Number(C.power??D.power??C.s_power??D.s_power??0),x=C.dan??D.dan??C.rank??D.rank??"-",z=Number(C.redQuenchCnt??D.redQuenchCnt??v["red:quench"]??v.red_quench??0),U=v["last:war:rank"]??v.lastWarRank??v["legion:last:war:rank"]??"-",O=!!(C.noApply??D.noApply);return{power:b,dan:x??"-",redQuench:z,lastWarRank:U,noApply:O}}),y=()=>{const D=s.selectedToken;D&&s.sendMessage(D.id,"legion_getinfo")},E=D=>D===1?"会长":D===2?"副会长":"成员",q=D=>{const C=Number(D||0);return C>=1e8?(C/1e8).toFixed(2)+"亿":C>=1e4?(C/1e4).toFixed(2)+"万":String(C)};return(D,C)=>{const v=te("n-empty"),b=te("n-button"),x=te("n-space"),z=te("n-avatar"),U=te("n-tab-pane"),O=te("n-tabs"),le=Me;return d(),ce(le,{class:"club-info",statusClass:{active:!!l.value}},{icon:m(()=>[...C[1]||(C[1]=[e("img",{src:ts,alt:"俱乐部图标"},null,-1)])]),title:m(()=>[...C[2]||(C[2]=[e("h3",null,"俱乐部信息",-1),e("p",null,"军团/俱乐部概览与成员",-1)])]),badge:m(()=>[e("span",null,f(l.value?"已加入":"暂无俱乐部"),1)]),default:m(()=>[l.value?(d(),g("div",mn,[e("div",vn,[u(x,{size:"small"},{default:m(()=>[u(b,{size:"small",onClick:y},{default:m(()=>[...C[4]||(C[4]=[V("刷新",-1)])]),_:1})]),_:1})]),u(O,{value:A.value,"onUpdate:value":C[0]||(C[0]=ie=>A.value=ie),type:"line",animated:""},{default:m(()=>[u(U,{name:"overview",tab:"概览","display-directive":"show:lazy"},{default:m(()=>[e("div",pn,[e("div",fn,[u(z,{size:48,src:l.value.logo||"/icons/xiaoyugan.png"},null,8,["src"]),e("div",_n,[e("div",gn,f(l.value.name),1),e("div",hn,"ID "+f(l.value.id)+" · Lv."+f(l.value.level)+" · 服务器 "+f(l.value.serverId),1)])]),e("div",yn,[u(x,{size:"small"},{default:m(()=>[u(b,{size:"small",disabled:k.value,type:"primary",onClick:R},{default:m(()=>[V(f(k.value?"已签到":"俱乐部签到"),1)]),_:1},8,["disabled"])]),_:1})]),e("div",kn,[e("div",bn,[C[5]||(C[5]=e("div",{class:"label"},"战力",-1)),e("div",wn,f(q(h.value.power)),1)]),e("div",$n,[C[6]||(C[6]=e("div",{class:"label"},"段位",-1)),e("div",Tn,f(h.value.dan),1)]),e("div",Cn,[C[7]||(C[7]=e("div",{class:"label"},"成员数",-1)),e("div",Sn,f(B.value),1)]),e("div",In,[C[8]||(C[8]=e("div",{class:"label"},"红洗次数",-1)),e("div",xn,f(h.value.redQuench),1)])]),l.value.announcement?(d(),g("div",Mn,[C[9]||(C[9]=e("div",{class:"label"},"公告",-1)),e("div",Dn,f(l.value.announcement),1)])):se("",!0),$.value?(d(),g("div",An,[C[10]||(C[10]=e("div",{class:"label"},"会长",-1)),e("div",Nn,[u(z,{size:32,src:$.value.headImg||"/icons/xiaoyugan.png"},null,8,["src"]),e("span",zn,f($.value.name),1)])])):se("",!0)])]),_:1}),u(U,{name:"members",tab:"成员","display-directive":"show:lazy"},{default:m(()=>[e("div",Wn,[e("div",Rn,[(d(!0),g(pe,null,ye(S.value,ie=>{var Z;return d(),g("div",{key:ie.roleId,class:"member-row"},[e("div",Un,[u(z,{size:28,src:ie.headImg||"/icons/xiaoyugan.png"},null,8,["src"]),e("span",Bn,f(ie.name),1)]),e("div",En,[e("span",Pn,f(q(ie.power||((Z=ie.custom)==null?void 0:Z.s_power)||0)),1),e("span",Hn,f(E(ie.job)),1)])])}),128))]),B.value>S.value.length?(d(),g("div",On,"仅显示前 "+f(S.value.length)+" 名(按战力)",1)):se("",!0)])]),_:1}),u(U,{name:"records",tab:"盐场战绩","display-directive":"show:lazy"},{default:m(()=>[u(cn,{inline:""})]),_:1})]),_:1},8,["value"])])):(d(),g("div",un,[u(v,{description:"暂无俱乐部"}),e("div",dn,[u(b,{size:"small",onClick:y},{default:m(()=>[...C[3]||(C[3]=[V("刷新",-1)])]),_:1})])]))]),_:1},8,["statusClass"])}}},Fn=he(Ln,[["__scopeId","data-v-4cb31180"]]),jn="/icons/1733492491706148.png",Gn={class:"status-card tower-status"},qn={class:"card-header"},Vn={class:"energy-display"},Qn={class:"energy-count"},Jn={class:"card-content"},Kn={class:"tower-floor"},Yn={class:"floor-number"},Xn={class:"card-actions"},Zn=["disabled"],ea={__name:"TowerStatus",setup(J){const s=fe(),a=ge(),o=G(!1),l=G(null);G(null);const _=I(()=>{var y;return((y=s.gameData)==null?void 0:y.roleInfo)||null}),T=I(()=>{var D,C;const h=(C=(D=_.value)==null?void 0:D.role)==null?void 0:C.tower;if(!h||!h.id&&h.id!==0)return"0 - 0";const y=h.id,E=Math.floor(y/10)+1,q=y%10+1;return`${E} - ${q}`}),B=I(()=>{var E,q;const h=(q=(E=_.value)==null?void 0:E.role)==null?void 0:q.tower;return(h==null?void 0:h.energy)||0}),$=I(()=>{const h=B.value>0,y=!o.value;return h&&y}),S=async()=>{if(!s.selectedToken){a.warning("请先选择Token");return}if(!$.value){a.warning("体力不足或正在爬塔中");return}l.value&&(clearTimeout(l.value),l.value=null),o.value=!0,l.value=setTimeout(()=>{o.value=!1,l.value=null},15e3);try{const h=s.selectedToken.id;await s.sendMessageWithPromise(h,"fight_starttower",{},1e4),a.success("爬塔命令已发送"),await k(),setTimeout(async()=>{await k(),l.value&&(clearTimeout(l.value),l.value=null),o.value=!1},2e3)}catch(h){a.error("爬塔失败: "+(h.message||"未知错误")),l.value&&(clearTimeout(l.value),l.value=null),o.value=!1}},A=()=>{l.value&&(clearTimeout(l.value),l.value=null),o.value=!1,a.info("爬塔状态已重置")},k=async()=>{if(s.selectedToken)try{const h=s.selectedToken.id;if(s.getWebSocketStatus(h)!=="connected")return;const E=s.sendMessage(h,"role_getroleinfo"),q=s.sendMessage(h,"tower_getinfo")}catch{}},R=I(()=>s.selectedToken?s.getWebSocketStatus(s.selectedToken.id):"disconnected");return me(R,(h,y)=>{h==="connected"&&y!=="connected"&&setTimeout(()=>{k()},1e3)}),me(()=>s.selectedToken,(h,y)=>{h&&h.id!==(y==null?void 0:y.id)&&s.getWebSocketStatus(h.id)==="connected"&&k()}),me(()=>s.gameData.towerResult,(h,y)=>{h&&h.timestamp!==(y==null?void 0:y.timestamp)&&(h.success?(a.success("咸将塔挑战成功！"),h.autoReward&&setTimeout(()=>{a.success(`自动领取第${h.rewardFloor}层奖励`)},1e3)):a.error("咸将塔挑战失败"),setTimeout(()=>{l.value&&(clearTimeout(l.value),l.value=null),o.value=!1},2e3))},{deep:!0}),ke(()=>{s.selectedToken&&s.getWebSocketClient(s.selectedToken.id),s.selectedToken&&R.value==="connected"&&k()}),(h,y)=>(d(),g("div",Gn,[e("div",qn,[y[1]||(y[1]=e("img",{src:jn,alt:"爬塔图标",class:"status-icon"},null,-1)),y[2]||(y[2]=e("div",{class:"status-info"},[e("h3",null,"咸将塔"),e("p",null,"一个不小心就过了")],-1)),e("div",Vn,[y[0]||(y[0]=e("img",{src:Ze,alt:"小鱼干",class:"energy-icon"},null,-1)),e("span",Qn,f(B.value),1)])]),e("div",Jn,[e("div",Kn,[y[3]||(y[3]=e("span",{class:"label"},"当前层数",-1)),e("span",Yn,f(T.value),1)])]),e("div",Xn,[e("button",{class:de(["climb-button",{active:$.value,disabled:!$.value}]),disabled:!$.value,onClick:S},f(o.value.value?"爬塔中...":"开始爬塔"),11,Zn),o.value.value?(d(),g("button",{key:0,class:"reset-button",onClick:A}," 重置状态 ")):se("",!0)])]))}},ta=he(ea,[["__scopeId","data-v-1b77bcb2"]]),sa="/icons/174023274867420.png",na={class:"status-card daily-task"},aa={class:"card-header"},oa={class:"header-right"},la={class:"card-content"},ia={class:"progress-container"},ra={class:"card-actions"},ca=["disabled"],ua={key:0,class:"loading-text"},da={key:1},ma={key:2},va={class:"modal-header"},pa={class:"settings-content"},fa={class:"settings-grid"},_a={class:"setting-item"},ga={class:"setting-item"},ha={class:"setting-item"},ya={class:"setting-switches"},ka={class:"switch-row"},ba={class:"switch-row"},wa={class:"switch-row"},$a={class:"switch-row"},Ta={class:"switch-row"},Ca={class:"switch-row"},Sa={class:"switch-row"},Ia={class:"modal-header"},xa=["disabled"],Ma={class:"task-list"},Da={class:"task-item-left"},Aa={class:"task-name"},Na={class:"modal-header"},za={class:"log-time"},Oe=500,Wa={__name:"DailyTaskStatus",setup(J){const s=fe(),a=ge(),o=G(!1),l=G(!1),_=G(!1),T=G(!1),B=G(null),$=je({arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0}),S=G([{id:1,name:"登录一次游戏",completed:!1,loading:!1},{id:2,name:"分享一次游戏",completed:!1,loading:!1},{id:3,name:"赠送好友3次金币",completed:!1,loading:!1},{id:4,name:"进行2次招募",completed:!1,loading:!1},{id:5,name:"领取5次挂机奖励",completed:!1,loading:!1},{id:6,name:"进行3次点金",completed:!1,loading:!1},{id:7,name:"开启3次宝箱",completed:!1,loading:!1},{id:12,name:"黑市购买1次物品（请设置采购清单）",completed:!1,loading:!1},{id:13,name:"进行1场竞技场战斗",completed:!1,loading:!1},{id:14,name:"收获1个任意盐罐",completed:!1,loading:!1}]),A=[1,2,3,4].map(i=>({label:`阵容${i}`,value:i})),k=[0,1,2,3,4].map(i=>({label:`${i}次`,value:i})),R=I(()=>s.selectedTokenRoleInfo),h=I(()=>{var i,t,p;return((p=(t=(i=R.value)==null?void 0:i.role)==null?void 0:t.dailyTask)==null?void 0:p.dailyPoint)??0}),y=I(()=>Math.min(h.value,100)),E=I(()=>y.value>=100),q=I(()=>E.value?"#10b981":"#3b82f6"),D=I(()=>s.selectedToken?s.getWebSocketStatus(s.selectedToken.id)==="connected":!1),C=G([]),v=(i,t="info")=>{const p=new Date().toLocaleTimeString();C.value.push({time:p,message:i,type:t}),C.value.length>Oe&&C.value.splice(0,C.value.length-Oe),qe(()=>{B.value&&(B.value.scrollTop=B.value.scrollHeight)})},b=i=>{var Y,X;if(!((X=(Y=i==null?void 0:i.role)==null?void 0:Y.dailyTask)!=null&&X.complete)){v("角色信息中无任务完成数据","warning");return}const t=i.role.dailyTask.complete,p=ee=>ee===-1;v("开始同步任务完成状态..."),v(`服务器返回的任务完成数据: ${JSON.stringify(t)}`);let c=0,j=0;S.value.forEach(ee=>{ee.completed=!1}),Object.keys(t).forEach(ee=>{const N=Number(ee),K=S.value.findIndex(ue=>ue.id===N);if(K>=0){const ue=p(t[ee]);S.value[K].completed=ue,c++,ue&&j++,v(`任务${N} "${S.value[K].name}": ${ue?"已完成":"未完成"}`,ue?"success":"info")}else v(`服务器返回未知任务ID: ${N} (完成值: ${t[ee]})`,"warning")}),v(`任务状态同步完成: ${j}/${c} 已完成`),v(`当前进度: ${h.value}/100`)},x=async()=>{if(!s.selectedToken)throw new Error("没有选中的Token");const i=s.selectedToken.id;v("正在获取角色信息...");try{const t=await s.sendGetRoleInfo(i);return v("角色信息获取成功","success"),t&&b(t),t}catch(t){throw v(`获取角色信息失败: ${t.message}`,"error"),t}},z=async(i,t,p={},c="",j=8e3)=>{try{c&&v(`执行: ${c}`);const Y=await s.sendMessageWithPromise(i,t,p,j);return await new Promise(X=>setTimeout(X,500)),c&&v(`${c} - 成功`,"success"),Y}catch(Y){throw c&&v(`${c} - 失败: ${Y.message}`,"error"),Y}},U=i=>{if(!i)return!0;const t=new Date().toDateString(),p=new Date(i).toDateString();return t!==p},O=()=>{const i=[9904,9905,9901,9902,9903,9904,9905],t=new Date().getDay();return i[t]},le=async(i,t,p,c)=>{var j,Y,X;try{const ee=(Y=(j=s.gameData)==null?void 0:j.presetTeam)==null?void 0:Y.presetTeamInfo;let N=ee==null?void 0:ee.useTeamId;if(N)c(`从缓存获取当前阵容: ${N}`);else{c("缓存中无阵容信息，从服务器获取...");const K=await z(i,"presetteam_getinfo",{},"获取阵容信息");N=(X=K==null?void 0:K.presetTeamInfo)==null?void 0:X.useTeamId,c(`从服务器获取当前阵容: ${N}`)}return N===t?(c(`当前已是${p}${t}，无需切换`,"success"),!1):(c(`当前阵容: ${N}, 目标阵容: ${t}，开始切换...`),await z(i,"presetteam_saveteam",{teamId:t},`切换到${p}${t}`),c(`成功切换到${p}${t}`,"success"),!0)}catch(ee){c(`阵容检查失败，直接切换: ${ee.message}`,"warning");try{return await z(i,"presetteam_saveteam",{teamId:t},`强制切换到${p}${t}`),!0}catch(N){throw c(`强制切换也失败: ${N.message}`,"error"),N}}},ie=async(i,t,p)=>{var r;const c=s.selectedToken.id,j=i==null?void 0:i.role;if(!j)throw new Error("角色数据不存在");t("开始执行每日任务补差");const Y=((r=j.dailyTask)==null?void 0:r.complete)??{},X=n=>Y[n]===-1,ee=j.statistics??{},N=j.statisticsTime??{},K=[];if(X(2)||K.push({name:"分享一次游戏",execute:()=>z(c,"system_mysharecallback",{isSkipShareCard:!0,type:2},"分享游戏")}),X(3)||K.push({name:"赠送好友金币",execute:()=>z(c,"friend_batch",{},"赠送好友金币")}),X(4)||(K.push({name:"免费招募",execute:()=>z(c,"hero_recruit",{recruitType:3,recruitNumber:1},"免费招募")}),$.payRecruit&&K.push({name:"付费招募",execute:()=>z(c,"hero_recruit",{recruitType:1,recruitNumber:1},"付费招募")})),!X(6)&&U(N["buy:gold"]))for(let n=0;n<3;n++)K.push({name:`免费点金 ${n+1}/3`,execute:()=>z(c,"system_buygold",{buyNum:1},`免费点金 ${n+1}`)});if(!X(5)&&$.claimHangUp){for(let n=0;n<4;n++)K.push({name:`挂机加钟 ${n+1}/4`,execute:()=>z(c,"system_mysharecallback",{isSkipShareCard:!0,type:2},`挂机加钟 ${n+1}`)});K.push({name:"领取挂机奖励",execute:()=>z(c,"system_claimhangupreward",{},"领取挂机奖励")}),K.push({name:"挂机加钟 5/5",execute:()=>z(c,"system_mysharecallback",{isSkipShareCard:!0,type:2},"挂机加钟 5")})}if(!X(7)&&$.openBox&&K.push({name:"开启木质宝箱",execute:()=>z(c,"item_openbox",{itemId:2001,number:10},"开启木质宝箱10个")}),!X(14)&&$.claimBottle&&K.push({name:"领取盐罐奖励",execute:()=>z(c,"bottlehelper_claim",{},"领取盐罐奖励")}),!X(13)&&$.arenaEnable&&K.push({name:"竞技场战斗",execute:async()=>{var n,w;if(t("开始竞技场战斗流程"),new Date().getHours()<8){t("当前时间未到8点，跳过竞技场战斗","warning");return}if(new Date().getHours()>22){t("当前时间已过22点，跳过竞技场战斗","warning");return}await le(c,$.arenaFormation,"竞技场阵容",t),await z(c,"arena_startarea",{},"开始竞技场");for(let M=1;M<=3;M++){t(`竞技场战斗 ${M}/3`);const H=await z(c,"arena_getareatarget",{refresh:!1},`获取竞技场目标${M}`),F=(w=(n=H==null?void 0:H.roleList)==null?void 0:n[0])==null?void 0:w.roleId;F?await z(c,"fight_startareaarena",{targetId:F},`竞技场战斗${M}`,1e4):t(`竞技场战斗${M} - 未找到目标`,"warning"),await new Promise(oe=>setTimeout(oe,1e3))}}}),$.bossTimes>0){const n=ee["legion:boss"]??0,w=Math.max($.bossTimes-n,0);if(w>0){K.push({name:"军团BOSS阵容检查",execute:()=>le(c,$.bossFormation,"BOSS阵容",t)});for(let H=0;H<w;H++)K.push({name:`军团BOSS ${H+1}/${w}`,execute:()=>z(c,"fight_startlegionboss",{},`军团BOSS ${H+1}`,12e3)})}const M=O();w===0&&K.push({name:"每日BOSS阵容检查",execute:()=>le(c,$.bossFormation,"BOSS阵容",t)});for(let H=0;H<3;H++)K.push({name:`每日BOSS ${H+1}/3`,execute:()=>z(c,"fight_startboss",{bossId:M},`每日BOSS ${H+1}`,12e3)})}const ue=[{name:"福利签到",cmd:"system_signinreward"},{name:"俱乐部",cmd:"legion_signin"},{name:"领取每日礼包",cmd:"discount_claimreward"},{name:"领取每日免费奖励",cmd:"collection_claimfreereward"},{name:"领取免费礼包",cmd:"card_claimreward"},{name:"领取永久卡礼包",cmd:"card_claimreward",params:{cardId:4003}}];if($.claimEmail&&ue.push({name:"领取邮件奖励",cmd:"mail_claimallattachment"}),ue.forEach(n=>{K.push({name:n.name,execute:()=>z(c,n.cmd,n.params||{},n.name)})}),U(N["artifact:normal:lottery:time"]))for(let n=0;n<3;n++)K.push({name:`免费钓鱼 ${n+1}/3`,execute:()=>z(c,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},`免费钓鱼 ${n+1}`)});const ve=["魏国","蜀国","吴国","群雄"];for(let n=1;n<=4;n++)U(N[`genie:daily:free:${n}`])&&K.push({name:`${ve[n-1]}灯神免费扫荡`,execute:()=>z(c,"genie_sweep",{genieId:n},`${ve[n-1]}灯神免费扫荡`)});for(let n=0;n<3;n++)K.push({name:`领取免费扫荡卷 ${n+1}/3`,execute:()=>z(c,"genie_buysweep",{},`领取免费扫荡卷 ${n+1}`)});!X(12)&&$.blackMarketPurchase&&K.push({name:"黑市购买1次物品",execute:()=>z(c,"store_purchase",{goodsId:1},"黑市购买1次物品")});for(let n=1;n<=10;n++)K.push({name:`领取任务奖励${n}`,execute:()=>z(c,"task_claimdailypoint",{taskId:n},`领取任务奖励${n}`,5e3)});K.push({name:"领取日常任务奖励",execute:()=>z(c,"task_claimdailyreward",{},"领取日常任务奖励")},{name:"领取周常任务奖励",execute:()=>z(c,"task_claimweekreward",{},"领取周常任务奖励")});const _e=K.length;t(`共有 ${_e} 个任务待执行`);for(let n=0;n<K.length;n++){const w=K[n];try{await w.execute();const M=Math.floor((n+1)/_e*100);p&&p(c,M),await new Promise(H=>setTimeout(H,500))}catch(M){t(`任务执行失败: ${w.name} - ${M.message}`,"error")}}p&&p(c,100),t("所有任务执行完成","success"),await new Promise(n=>setTimeout(n,2e3)),await x()},Z=async()=>{var i;if(!s.selectedToken||T.value){a.warning("没有选中Token或正在执行中");return}if(!D.value){a.error("WebSocket连接未建立，请检查连接状态");return}T.value=!0,_.value=!0,C.value=[];try{v("=== 开始执行一键补差任务 ===");const t=await x();if(!(t!=null&&t.role))throw new Error("获取角色信息失败或数据异常");v(`当前每日任务进度: ${((i=t.role.dailyTask)==null?void 0:i.dailyPoint)||0}/100`),v("第二步: 开始执行每日任务..."),await ie(t,v,(p,c)=>{v(`任务进度: ${c}%`)}),v("=== 任务执行完成 ===","success"),a.success("每日任务补差执行完成"),setTimeout(async()=>{try{await x(),v("最终角色信息刷新完成","success")}catch(p){v(`最终刷新失败: ${p.message}`,"warning")}},3e3)}catch(t){v(`任务执行失败: ${t.message}`,"error"),console.error("详细错误信息:",t),a.error(`任务执行失败: ${t.message}`)}finally{T.value=!1}},L=async()=>{if(!D.value){a.warning("WebSocket未连接，无法刷新任务状态");return}try{v("手动刷新任务状态..."),await x(),a.success("任务状态刷新成功")}catch(i){v(`刷新失败: ${i.message}`,"error"),a.error(`刷新失败: ${i.message}`)}},ae=()=>s.selectedToken?{roleId:s.selectedToken.id}:null,Q=i=>{try{const t=localStorage.getItem(`daily-settings:${i}`);return t?JSON.parse(t):null}catch(t){return console.error("Failed to load settings:",t),null}},P=(i,t)=>{try{localStorage.setItem(`daily-settings:${i}`,JSON.stringify(t))}catch(p){console.error("Failed to save settings:",p)}};return me($,i=>{const t=ae();t&&P(t.roleId,i)},{deep:!0}),me(()=>s.selectedToken,async(i,t)=>{if(i&&i!==t){v(`切换到Token: ${i.name}`);const p=Q(i.id);if(p&&Object.assign($,p),D.value)try{await x()}catch(c){console.warn("切换token后获取角色信息失败:",c.message)}}},{immediate:!0}),me(()=>s.selectedTokenRoleInfo,i=>{var t,p;(p=(t=i==null?void 0:i.role)==null?void 0:t.dailyTask)!=null&&p.complete&&(v("角色信息更新，同步任务状态"),b(i))},{immediate:!0,deep:!0}),ke(async()=>{if(v("组件初始化完成"),s.selectedToken&&D.value)try{await x()}catch(t){console.warn("初始化时获取角色信息失败:",t.message)}const i=ae();if(i){const t=Q(i.roleId);t&&Object.assign($,t)}}),Ge(()=>{v("组件即将卸载")}),(i,t)=>{const p=te("n-progress"),c=te("n-icon"),j=te("n-select"),Y=te("n-switch"),X=te("n-modal"),ee=te("n-tag");return d(),g("div",na,[e("div",aa,[t[17]||(t[17]=e("img",{src:sa,alt:"每日任务",class:"status-icon"},null,-1)),t[18]||(t[18]=e("div",{class:"status-info"},[e("h3",null,"每日任务"),e("p",null,"当前进度")],-1)),e("div",oa,[e("div",{class:de(["status-badge",{completed:E.value}]),onClick:t[0]||(t[0]=N=>l.value=!0)},[e("div",{class:de(["status-dot",{completed:E.value}])},null,2),t[15]||(t[15]=e("span",null,"任务详情",-1))],2),e("button",{class:"settings-gear",onClick:t[1]||(t[1]=N=>o.value=!0),title:"任务设置"},[...t[16]||(t[16]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[e("path",{d:"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.240.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"}),e("path",{d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)])])])]),e("div",la,[e("div",ia,[u(p,{type:"line",percentage:y.value,height:8,"border-radius":4,color:q.value,"rail-color":"#f3f4f6"},null,8,["percentage","color"])]),t[19]||(t[19]=e("div",{class:"info-container"}," 右上角小齿轮有惊喜 ",-1))]),e("div",ra,[e("button",{class:"action-button",disabled:T.value||!D.value,onClick:Z},[T.value?(d(),g("span",ua,[...t[20]||(t[20]=[e("svg",{class:"loading-icon",viewBox:"0 0 24 24"},[e("path",{fill:"currentColor",d:"M12 22c5.421 0 10-4.579 10-10h-2c0 4.337-3.663 8-8 8s-8-3.663-8-8c0-4.336 3.663-8 8-8V2C6.579 2 2 6.58 2 12c0 5.421 4.579 10 10 10z"})],-1),V(" 执行中... ",-1)])])):D.value?(d(),g("span",ma,"一键补差")):(d(),g("span",da,"WebSocket未连接"))],8,ca)]),u(X,{show:o.value,"onUpdate:show":t[12]||(t[12]=N=>o.value=N),preset:"card",title:"任务设置",style:{width:"400px"}},{header:m(()=>[e("div",va,[u(c,null,{default:m(()=>[u(ne(et))]),_:1}),t[21]||(t[21]=e("span",null,"任务设置",-1))])]),default:m(()=>[e("div",pa,[e("div",fa,[e("div",_a,[t[22]||(t[22]=e("label",{class:"setting-label"},"竞技场阵容",-1)),u(j,{value:$.arenaFormation,"onUpdate:value":t[2]||(t[2]=N=>$.arenaFormation=N),options:ne(A),size:"small"},null,8,["value","options"])]),e("div",ga,[t[23]||(t[23]=e("label",{class:"setting-label"},"BOSS阵容",-1)),u(j,{value:$.bossFormation,"onUpdate:value":t[3]||(t[3]=N=>$.bossFormation=N),options:ne(A),size:"small"},null,8,["value","options"])]),e("div",ha,[t[24]||(t[24]=e("label",{class:"setting-label"},"BOSS次数",-1)),u(j,{value:$.bossTimes,"onUpdate:value":t[4]||(t[4]=N=>$.bossTimes=N),options:ne(k),size:"small"},null,8,["value","options"])]),e("div",ya,[e("div",ka,[t[25]||(t[25]=e("span",{class:"switch-label"},"领罐子",-1)),u(Y,{value:$.claimBottle,"onUpdate:value":t[5]||(t[5]=N=>$.claimBottle=N)},null,8,["value"])]),e("div",ba,[t[26]||(t[26]=e("span",{class:"switch-label"},"领挂机",-1)),u(Y,{value:$.claimHangUp,"onUpdate:value":t[6]||(t[6]=N=>$.claimHangUp=N)},null,8,["value"])]),e("div",wa,[t[27]||(t[27]=e("span",{class:"switch-label"},"竞技场",-1)),u(Y,{value:$.arenaEnable,"onUpdate:value":t[7]||(t[7]=N=>$.arenaEnable=N)},null,8,["value"])]),e("div",$a,[t[28]||(t[28]=e("span",{class:"switch-label"},"开宝箱",-1)),u(Y,{value:$.openBox,"onUpdate:value":t[8]||(t[8]=N=>$.openBox=N)},null,8,["value"])]),e("div",Ta,[t[29]||(t[29]=e("span",{class:"switch-label"},"领取邮件奖励",-1)),u(Y,{value:$.claimEmail,"onUpdate:value":t[9]||(t[9]=N=>$.claimEmail=N)},null,8,["value"])]),e("div",Ca,[t[30]||(t[30]=e("span",{class:"switch-label"},"黑市购买物品",-1)),u(Y,{value:$.blackMarketPurchase,"onUpdate:value":t[10]||(t[10]=N=>$.blackMarketPurchase=N)},null,8,["value"])]),e("div",Sa,[t[31]||(t[31]=e("span",{class:"switch-label"},"付费招募",-1)),u(Y,{value:$.payRecruit,"onUpdate:value":t[11]||(t[11]=N=>$.payRecruit=N)},null,8,["value"])])])])])]),_:1},8,["show"]),u(X,{show:l.value,"onUpdate:show":t[13]||(t[13]=N=>l.value=N),preset:"card",title:"每日任务详情",style:{width:"400px"}},{header:m(()=>[e("div",Ia,[u(c,null,{default:m(()=>[u(ne(lt))]),_:1}),t[33]||(t[33]=e("span",null,"每日任务详情",-1)),e("button",{class:"refresh-button",disabled:T.value,onClick:L},[u(c,null,{default:m(()=>[u(ne(Ae))]),_:1}),t[32]||(t[32]=V(" 刷新状态 ",-1))],8,xa)])]),default:m(()=>[e("div",Ma,[(d(!0),g(pe,null,ye(S.value,N=>(d(),g("div",{key:N.id,class:"task-item"},[e("div",Da,[u(c,{class:de(["task-status-icon",{completed:N.completed}])},{default:m(()=>[N.completed?(d(),ce(ne(tt),{key:0})):(d(),ce(ne(bt),{key:1}))]),_:2},1032,["class"]),e("span",Aa,f(N.name),1)]),u(ee,{type:N.completed?"success":"default",size:"small"},{default:m(()=>[V(f(N.completed?"已完成":"未完成"),1)]),_:2},1032,["type"])]))),128))])]),_:1},8,["show"]),u(X,{show:_.value,"onUpdate:show":t[14]||(t[14]=N=>_.value=N),preset:"card",title:"任务执行日志",style:{width:"500px"}},{header:m(()=>[e("div",Na,[u(c,null,{default:m(()=>[u(ne(Ne))]),_:1}),t[34]||(t[34]=e("span",null,"任务执行日志",-1))])]),default:m(()=>[e("div",{ref_key:"logContainer",ref:B,class:"log-container"},[(d(!0),g(pe,null,ye(C.value,N=>(d(),g("div",{key:N.time+N.message,class:"log-item"},[e("span",za,f(N.time),1),e("span",{class:de(["log-message",{error:N.type==="error",success:N.type==="success",warning:N.type==="warning"}])},f(N.message),3)]))),128))],512)]),_:1},8,["show"])])}}},Ra=he(Wa,[["__scopeId","data-v-a3bc125f"]]),ze="/icons/Ob7pyorzmHiJcbab2c25af264d0758b527bc1b61cc3b.png",Ua={class:"status-card team-formation-card"},Ba={class:"card-header"},Ea={class:"team-selector"},Pa=["disabled","onClick"],Ha=["disabled"],Oa={class:"card-content"},La={class:"current-team-info"},Fa={class:"team-number"},ja={class:"heroes-container"},Ga={key:0,class:"heroes-inline"},qa={class:"hero-circle"},Va=["src","alt"],Qa={key:1,class:"hero-placeholder"},Ja={class:"hero-name"},Ka={key:1,class:"empty-team"},Ya={key:2,class:"empty-team"},Xa=Ce({__name:"TeamFormation",setup(J){const s=fe(),a=ge(),o=G(!1),l=G(!1),_=G(1),T=G([1,2,3,4]),B={101:{name:"司马懿",type:"魏国"},102:{name:"郭嘉",type:"魏国"},103:{name:"关羽",type:"蜀国"},104:{name:"诸葛亮",type:"蜀国"},105:{name:"周瑜",type:"吴国"},106:{name:"太史慈",type:"吴国"},107:{name:"吕布",type:"群雄"},108:{name:"华佗",type:"群雄"},109:{name:"甄姬",type:"魏国"},110:{name:"黄月英",type:"蜀国"},111:{name:"孙策",type:"吴国"},112:{name:"贾诩",type:"群雄"},113:{name:"曹仁",type:"魏国"},114:{name:"姜维",type:"蜀国"},115:{name:"孙坚",type:"吴国"},116:{name:"公孙瓒",type:"群雄"},117:{name:"典韦",type:"魏国"},118:{name:"赵云",type:"蜀国"},119:{name:"大乔",type:"吴国"},120:{name:"张角",type:"群雄"},201:{name:"徐晃",type:"魏国"},202:{name:"荀彧",type:"魏国"},203:{name:"典韦",type:"魏国"},204:{name:"张飞",type:"蜀国"},205:{name:"赵云",type:"蜀国"},206:{name:"庞统",type:"蜀国"},207:{name:"鲁肃",type:"吴国"},208:{name:"陆逊",type:"吴国"},209:{name:"甘宁",type:"吴国"},210:{name:"貂蝉",type:"群雄"},211:{name:"董卓",type:"群雄"},212:{name:"张角",type:"群雄"},213:{name:"张辽",type:"魏国"},214:{name:"夏侯惇",type:"魏国"},215:{name:"许褚",type:"魏国"},216:{name:"夏侯渊",type:"魏国"},217:{name:"魏延",type:"蜀国"},218:{name:"黄忠",type:"蜀国"},219:{name:"马超",type:"蜀国"},220:{name:"马岱",type:"蜀国"},221:{name:"吕蒙",type:"吴国"},222:{name:"黄盖",type:"吴国"},223:{name:"蔡文姬",type:"魏国"},224:{name:"小乔",type:"吴国"},225:{name:"袁绍",type:"群雄"},226:{name:"华雄",type:"群雄"},227:{name:"颜良",type:"群雄"},228:{name:"文丑",type:"群雄"},301:{name:"周泰",type:"吴国"},302:{name:"许攸",type:"魏国"},303:{name:"于禁",type:"魏国"},304:{name:"张星彩",type:"蜀国"},305:{name:"关银屏",type:"蜀国"},306:{name:"关平",type:"蜀国"},307:{name:"程普",type:"吴国"},308:{name:"张昭",type:"吴国"},309:{name:"陆绩",type:"吴国"},310:{name:"吕玲绮",type:"群雄"},311:{name:"潘凤",type:"群雄"},312:{name:"邢道荣",type:"群雄"},313:{name:"祝融夫人",type:"群雄"},314:{name:"孟获",type:"群雄"}},$=I(()=>s.selectedToken?s.getWebSocketStatus(s.selectedToken.id):"disconnected"),S=I(()=>{var v;return((v=s.gameData)==null?void 0:v.presetTeam)??null});function A(v){var ie;if(!v)return{useTeamId:1,teams:{}};const b=v.presetTeamInfo??v,x=Z=>{if(!Z||typeof Z!="object")return null;if(typeof Z.useTeamId=="number")return Z.useTeamId;for(const L of Object.keys(Z)){const ae=x(Z[L]);if(ae)return ae}return null},z=b.useTeamId??((ie=b.presetTeamInfo)==null?void 0:ie.useTeamId)??x(b)??1,U=b.presetTeamInfo??b,O={},le=Object.keys(U||{}).filter(Z=>/^\d+$/.test(Z));for(const Z of le){const L=Number(Z),ae=U[Z];if(!ae){O[L]={teamInfo:{}};continue}if(ae.teamInfo)O[L]={teamInfo:ae.teamInfo};else if(ae.heroes){const Q={};ae.heroes.forEach((P,i)=>{Q[String(i+1)]=P}),O[L]={teamInfo:Q}}else if(typeof ae=="object"){const Q=Object.values(ae).some(P=>P&&typeof P=="object"&&"heroId"in P);O[L]={teamInfo:Q?ae:{}}}else O[L]={teamInfo:{}}}return{useTeamId:Number(z)||1,teams:O}}const k=I(()=>A(S.value)),R=I(()=>{var x;const v=(x=k.value.teams[_.value])==null?void 0:x.teamInfo;if(!v)return[];const b=[];for(const[z,U]of Object.entries(v)){const O=(U==null?void 0:U.heroId)??(U==null?void 0:U.id);if(!O)continue;const le=B[Number(O)];b.push({id:Number(O),name:(le==null?void 0:le.name)??`英雄${O}`,type:(le==null?void 0:le.type)??"",position:Number(z),level:(U==null?void 0:U.level)??1,avatar:U==null?void 0:U.avatar})}return b.sort((z,U)=>z.position-U.position),b}),h=async(v,b,x={},z="",U=8e3)=>{try{return await s.sendMessageWithPromise(v,b,x,U)}catch(O){throw z&&a.error(`${z}失败：${(O==null?void 0:O.message)??O}`),O}},y=async(v=!1)=>{var x,z;if(!s.selectedToken)return a.warning("请先选择Token"),null;const b=s.selectedToken.id;if(!v){const U=(z=(x=s.gameData)==null?void 0:x.presetTeam)==null?void 0:z.presetTeamInfo;if(U)return U}o.value=!0;try{const U=await h(b,"presetteam_getinfo",{},"获取阵容信息");return s.$patch(O=>{O.gameData={...O.gameData??{},presetTeam:U}}),(U==null?void 0:U.presetTeamInfo)??null}catch(U){return console.error("获取阵容信息失败:",U),null}finally{o.value=!1}},E=()=>{const v=Object.keys(k.value.teams).map(Number).filter(b=>!Number.isNaN(b)).sort((b,x)=>b-x);T.value=v.length?v:[1,2,3,4]},q=()=>{_.value=k.value.useTeamId||1},D=async v=>{if(l.value||o.value)return;if(!s.selectedToken){a.warning("请先选择Token");return}const b=_.value;l.value=!0;try{await h(s.selectedToken.id,"presetteam_saveteam",{teamId:v},`切换到阵容 ${v}`),_.value=v,a.success(`已切换到阵容 ${v}`),await C(!0)}catch{_.value=b}finally{l.value=!1}},C=async(v=!1)=>{await y(v)};return ke(async()=>{s.selectedToken&&$.value==="connected"&&(await C(!1),E(),q(),S.value||(await C(!0),E(),q()))}),me($,(v,b)=>{v==="connected"&&b!=="connected"&&s.selectedToken&&setTimeout(async()=>{await C(!1),E(),q(),S.value||(await C(!0),E(),q())},1e3)}),me(()=>s.selectedToken,async(v,b)=>{v&&v.id!==(b==null?void 0:b.id)&&s.getWebSocketStatus(v.id)==="connected"&&(await C(!0),E(),q())}),me(()=>S.value,()=>{E(),q()},{deep:!0}),(v,b)=>(d(),g("div",Ua,[e("div",Ba,[b[2]||(b[2]=e("img",{src:ze,alt:"阵容",class:"icon"},null,-1)),b[3]||(b[3]=e("div",{class:"info"},[e("h3",null,"阵容"),e("p",null,"当前使用的战斗阵容")],-1)),e("div",Ea,[(d(!0),g(pe,null,ye(T.value,x=>(d(),g("button",{key:x,disabled:o.value||l.value,class:de(["team-button",{active:_.value===x}]),onClick:z=>D(x)},f(x),11,Pa))),128)),e("button",{class:"refresh-button",disabled:o.value,title:"刷新队伍数据",onClick:b[0]||(b[0]=x=>C(!0))},[...b[1]||(b[1]=[Ve('<svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-c736ceea><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" data-v-c736ceea></path><path d="M21 3v5h-5" data-v-c736ceea></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" data-v-c736ceea></path><path d="M3 21v-5h5" data-v-c736ceea></path></svg><span class="refresh-text" data-v-c736ceea>刷新</span>',2)])],8,Ha)])]),e("div",Oa,[e("div",La,[b[4]||(b[4]=e("span",{class:"label"},"当前阵容",-1)),e("span",Fa,[o.value?(d(),g(pe,{key:1},[V("加载中…")],64)):(d(),g(pe,{key:0},[V("阵容 "+f(_.value),1)],64))])]),e("div",ja,[o.value?se("",!0):(d(),g("div",Ga,[(d(!0),g(pe,null,ye(R.value,x=>{var z;return d(),g("div",{key:x.id||x.name,class:"hero-item"},[e("div",qa,[x.avatar?(d(),g("img",{key:0,src:x.avatar,alt:x.name,class:"hero-avatar"},null,8,Va)):(d(),g("div",Qa,f(((z=x.name)==null?void 0:z.substring(0,2))||"?"),1))]),e("span",Ja,f(x.name||"未知"),1)])}),128))])),!o.value&&!R.value.length?(d(),g("div",Ka,[...b[5]||(b[5]=[e("p",null,"暂无队伍信息",-1)])])):se("",!0),o.value?(d(),g("div",Ya,[...b[6]||(b[6]=[e("p",null,"正在加载队伍信息…",-1)])])):se("",!0)])])]))}}),Za=he(Xa,[["__scopeId","data-v-c736ceea"]]),eo={key:0,class:"identity-embedded"},to={class:"identity-card embedded"},so={class:"role-profile-content"},no={class:"avatar-container"},ao=["src","alt"],oo={class:"role-info-section"},lo={class:"role-name"},io={class:"role-stats"},ro={class:"level-text"},co={class:"power-value"},uo={class:"rank-section"},mo={class:"rank-icon"},vo={class:"rank-title"},po={key:1,class:"resources"},fo={class:"label"},_o={class:"value"},go={key:2,class:"loading"},ho={class:"identity-card"},yo={class:"card-header"},ko={class:"role-profile-content"},bo={class:"avatar-container"},wo=["src","alt"],$o={class:"role-info-section"},To={class:"role-name"},Co={class:"role-stats"},So={class:"level-text"},Io={class:"power-value"},xo={class:"rank-section"},Mo={class:"rank-icon"},Do={class:"rank-title"},Ao={key:1,class:"loading"},No=Ce({__name:"IdentityCard",props:{visible:{type:Boolean},embedded:{type:Boolean}},emits:["close"],setup(J,{emit:s}){const a=fe(),o=s,l=I(()=>a.selectedToken?a.getWebSocketStatus(a.selectedToken.id):"disconnected"),_=I(()=>{var t,p;const P=a.gameData,i=(t=P==null?void 0:P.roleInfo)==null?void 0:t.role;return i?{roleId:i.roleId,name:i.name,headImg:i.headImg,level:i.level,power:i.power||i.fighting||0,gold:i.gold??0,diamond:i.diamond??0,fishing:i.fishing||i.fish||null,items:i.items||i.itemList||((p=i.bag)==null?void 0:p.items)||i.inventory||null}:{}}),T=I(()=>Object.keys(_.value||{}).length>0),B=["/icons/1733492491706148.png","/icons/1733492491706152.png","/icons/1736425783912140.png","/icons/173746572831736.png","/icons/174023274867420.png"],$=G(""),S=G(""),A=[{min:0,max:1e6,title:"初出茅庐",icon:"🌱",class:"rank-beginner"},{min:1e6,max:1e7,title:"小有名气",icon:"⚔️",class:"rank-known"},{min:1e7,max:1e8,title:"出入江湖",icon:"🗡️",class:"rank-veteran"},{min:1e8,max:5e8,title:"纵横四方",icon:"🏹",class:"rank-master"},{min:5e8,max:2e9,title:"盖世豪杰",icon:"⚡",class:"rank-hero"},{min:2e9,max:4e9,title:"一方枭雄",icon:"👑",class:"rank-overlord"},{min:4e9,max:6e9,title:"睥睨江湖",icon:"🔱",class:"rank-supreme"},{min:6e9,max:9e9,title:"独霸天下",icon:"⚜️",class:"rank-emperor"},{min:9e9,max:15e9,title:"不世之尊",icon:"💎",class:"rank-legend"},{min:15e9,max:1/0,title:"无极至尊",icon:"🌟",class:"rank-infinite"}],k=I(()=>{const P=Number(_.value.power||0);return A.find(i=>P>=i.min&&P<i.max)||A[0]}),R=P=>{if(!P)return"0";const i=1e8,t=1e4;return P>=i?(P/i).toFixed(1)+"亿":P>=t?(P/t).toFixed(1)+"万":P.toLocaleString()},h=P=>{const i=Number(P||0),t=1e8,p=1e4;return i>=t?(i/t).toFixed(1)+"亿":i>=p?(i/p).toFixed(1)+"万":i.toLocaleString()},y=I(()=>_.value.gold??0),E=I(()=>_.value.diamond??0),q=(P,i)=>{if(!P)return null;if(Array.isArray(P)){const p=P.find(c=>Number(c.id??c.itemId)===i);return p?Number(p.num??p.count??p.quantity??0):0}const t=P[String(i)]??P[i];if(t==null){const p=Object.values(P).find(c=>Number((c==null?void 0:c.itemId)??(c==null?void 0:c.id))===i);return p?Number(p.num??p.count??p.quantity??0):0}return typeof t=="number"?Number(t):typeof t=="object"?Number(t.num??t.count??t.quantity??0):Number(t)||0},D=I(()=>_.value.items),C=I(()=>q(D.value,1011)),v=I(()=>q(D.value,1012)),b=I(()=>q(D.value,108)),x=I(()=>q(D.value,1001)),z=I(()=>q(D.value,1006)),U=I(()=>q(D.value,1023)),O=I(()=>q(D.value,1003)),le=I(()=>{var i,t,p,c;const P=C.value;return P??((t=(i=_.value)==null?void 0:i.fishing)==null?void 0:t.normalRod)??((c=(p=_.value)==null?void 0:p.fishing)==null?void 0:c.rod)??null}),ie=I(()=>{var i,t,p,c;const P=v.value;return P??((t=(i=_.value)==null?void 0:i.fishing)==null?void 0:t.goldRod)??((c=(p=_.value)==null?void 0:p.fishing)==null?void 0:c.vipRod)??null}),Z=P=>P==null?"-":h(Number(P)),L=I(()=>[{label:"金币",value:h(y.value)},{label:"金砖",value:h(E.value)},{label:"普通鱼竿",value:Z(le.value)},{label:"金鱼竿",value:Z(ie.value)},{label:"珍珠",value:Z(b.value)},{label:"招募令",value:Z(x.value)},{label:"精铁",value:Z(z.value)},{label:"彩玉",value:Z(U.value)},{label:"进阶石",value:Z(O.value)}]),ae=()=>{if(_.value&&_.value.headImg)$.value=_.value.headImg;else{if(!S.value){const P=_.value.roleId||_.value.name||"default",i=Array.from(String(P)).reduce((t,p)=>t+p.charCodeAt(0),0);S.value=B[i%B.length]}$.value=S.value}},Q=()=>{if(!S.value){const P=Math.floor(Math.random()*B.length);S.value=B[P]}$.value=S.value};return ke(async()=>{if(ae(),a.selectedToken&&l.value==="connected")try{await a.sendMessage(a.selectedToken.id,"role_getroleinfo")}catch{}}),me(()=>_.value,ae,{deep:!0}),(P,i)=>J.embedded?(d(),g("div",eo,[e("div",to,[i[2]||(i[2]=e("div",{class:"card-header"},[e("img",{src:ze,alt:"身份牌",class:"icon"}),e("div",{class:"info"},[e("h3",null,"身份牌"),e("p",null,"角色与资源概览")])],-1)),T.value?(d(),g("div",{key:0,class:de(["role-profile-header",k.value.class])},[e("div",so,[e("div",no,[e("img",{src:$.value,alt:_.value.name||"角色",class:"role-avatar",onError:Q},null,40,ao)]),e("div",oo,[e("div",lo,f(_.value.name||"未知角色"),1),e("div",io,[e("span",ro,"Lv."+f(_.value.level||1),1),e("span",co,"战力 "+f(R(_.value.power)),1)])]),e("div",uo,[e("div",mo,f(k.value.icon),1),e("div",vo,f(k.value.title),1)])])],2)):se("",!0),T.value?(d(),g("div",po,[(d(!0),g(pe,null,ye(L.value,t=>(d(),g("div",{key:t.label,class:"res-item"},[e("span",fo,f(t.label),1),e("span",_o,f(t.value),1)]))),128))])):(d(),g("div",go,"正在获取角色信息..."))])])):(d(),ce(Je,{key:1,name:"drop"},{default:m(()=>[$e(e("div",{class:"identity-overlay",onClick:i[1]||(i[1]=Qe(t=>o("close"),["self"]))},[e("div",ho,[i[6]||(i[6]=e("div",{class:"strap"},[e("div",{class:"strap-tape"}),e("div",{class:"strap-buckle"})],-1)),e("div",yo,[i[3]||(i[3]=e("img",{src:ze,alt:"身份牌",class:"icon"},null,-1)),i[4]||(i[4]=e("div",{class:"info"},[e("h3",null,"身份牌"),e("p",null,"角色与战力概览")],-1)),e("button",{class:"close-btn",onClick:i[0]||(i[0]=t=>o("close"))},"✕")]),T.value?(d(),g("div",{key:0,class:de(["role-profile-header",k.value.class])},[e("div",ko,[e("div",bo,[e("img",{src:$.value,alt:_.value.name||"角色",class:"role-avatar",onError:Q},null,40,wo)]),e("div",$o,[e("div",To,f(_.value.name||"未知角色"),1),e("div",Co,[e("span",So,"Lv."+f(_.value.level||1),1),e("span",Io,"战力 "+f(R(_.value.power)),1)])]),e("div",xo,[e("div",Mo,f(k.value.icon),1),e("div",Do,f(k.value.title),1)])]),i[5]||(i[5]=e("div",{class:"glow-border"},null,-1))],2)):(d(),g("div",Ao,"正在获取角色信息..."))])],512),[[Te,J.visible]])]),_:1}))}}),zo=he(No,[["__scopeId","data-v-a13099e7"]]),Wo="/icons/173746572831736.png",Ro={class:"time-display"},Uo={__name:"BottleHelperCard",setup(J){const s=fe(),a=ge(),o=I(()=>{var S;return((S=s.gameData)==null?void 0:S.roleInfo)||null}),l=G({isRunning:!1,remainingTime:0,stopTime:0}),_=S=>{const A=Math.floor(Number(S)||0);if(A<=0)return"00:00:00";const k=Math.floor(A/3600).toString().padStart(2,"0"),R=Math.floor(A%3600/60).toString().padStart(2,"0"),h=(A%60).toString().padStart(2,"0");return`${k}:${R}:${h}`},T=()=>{var k;const S=(k=o.value)==null?void 0:k.role;if(!(S!=null&&S.bottleHelpers))return;const A=Date.now()/1e3;l.value.stopTime=S.bottleHelpers.helperStopTime,l.value.isRunning=S.bottleHelpers.helperStopTime>A,l.value.remainingTime=Math.max(0,Math.floor(S.bottleHelpers.helperStopTime-A))};me(o,()=>T(),{deep:!0,immediate:!0});let B=null;ke(()=>{B=setInterval(()=>{l.value.isRunning&&l.value.remainingTime>0&&(l.value.remainingTime=Math.max(0,l.value.remainingTime-1),l.value.remainingTime<=0&&(l.value.isRunning=!1))},1e3)}),xe(()=>{B&&clearInterval(B)});const $=()=>{if(!s.selectedToken){a.warning("请先选择Token");return}const S=s.selectedToken.id;s.sendMessage(S,"bottlehelper_stop"),setTimeout(()=>{s.sendMessage(S,"bottlehelper_start"),s.sendMessage(S,"role_getroleinfo")},500),a.info(l.value.isRunning?"重启盐罐机器人":"启动盐罐机器人")};return(S,A)=>{const k=Le;return d(),ce(Me,{class:"bottle-helper",statusClass:{active:l.value.isRunning}},{icon:m(()=>[...A[0]||(A[0]=[e("img",{src:Wo,alt:"盐罐图标"},null,-1)])]),title:m(()=>[...A[1]||(A[1]=[e("h3",null,"盐罐机器人",-1),e("p",null,"剩余时间",-1)])]),badge:m(()=>[e("span",null,f(l.value.isRunning?"运行中":"已停止"),1)]),default:m(()=>[e("div",Ro,f(_(l.value.remainingTime)),1)]),action:m(()=>[u(k,{type:"primary",secondary:"",size:"small",block:"",onClick:$},{default:m(()=>[V(f(l.value.isRunning?"重启服务":"启动服务"),1)]),_:1})]),_:1},8,["statusClass"])}}},Bo=he(Uo,[["__scopeId","data-v-e178c49e"]]),Eo="/icons/174061875626614.png",Po={class:"time-display"},Ho=["disabled"],Oo={key:0,class:"loading-text"},Lo={key:1},Fo=["disabled"],jo={key:0,class:"loading-text"},Go={key:1},qo={__name:"HangUpStatusCard",setup(J){const s=fe(),a=ge(),o=I(()=>{var A;return((A=s.gameData)==null?void 0:A.roleInfo)||null}),l=G({isActive:!1,remainingTime:0,elapsedTime:0,lastTime:0,hangUpTime:0,isExtending:!1,isClaiming:!1}),_=A=>{const k=Math.floor(Number(A)||0);if(k<=0)return"00:00:00";const R=Math.floor(k/3600).toString().padStart(2,"0"),h=Math.floor(k%3600/60).toString().padStart(2,"0"),y=(k%60).toString().padStart(2,"0");return`${R}:${h}:${y}`},T=()=>{var h;const A=(h=o.value)==null?void 0:h.role;if(!(A!=null&&A.hangUp))return;const k=Date.now()/1e3;l.value.lastTime=A.hangUp.lastTime,l.value.hangUpTime=A.hangUp.hangUpTime;const R=k-l.value.lastTime;R<=l.value.hangUpTime?(l.value.remainingTime=Math.floor(l.value.hangUpTime-R),l.value.isActive=!0):(l.value.remainingTime=0,l.value.isActive=!1),l.value.elapsedTime=Math.floor(l.value.hangUpTime-l.value.remainingTime)};me(o,()=>T(),{deep:!0,immediate:!0});let B=null;ke(()=>{B=setInterval(()=>{l.value.isActive&&l.value.remainingTime>0&&(l.value.remainingTime=Math.max(0,l.value.remainingTime-1),l.value.elapsedTime=l.value.elapsedTime+1,l.value.remainingTime<=0&&(l.value.isActive=!1))},1e3)}),xe(()=>{B&&clearInterval(B)});const $=async()=>{if(!s.selectedToken)return a.warning("请先选择Token");const A=s.selectedToken.id;try{l.value.isExtending=!0,a.info("正在加钟...");const k=[];for(let R=0;R<4;R++)k.push(new Promise(h=>{setTimeout(()=>{s.sendMessage(A,"system_mysharecallback",{isSkipShareCard:!0,type:2}),h()},R*300)}));await Promise.all(k),setTimeout(()=>s.sendMessage(A,"role_getroleinfo"),1500),setTimeout(()=>{a.success("加钟操作已完成，请查看挂机剩余时间"),l.value.isExtending=!1},2500)}catch(k){a.error("加钟操作失败: "+((k==null?void 0:k.message)||"未知错误")),l.value.isExtending=!1}},S=async()=>{if(!s.selectedToken)return a.warning("请先选择Token");const A=s.selectedToken.id;try{l.value.isClaiming=!0,a.info("正在领取挂机奖励..."),s.sendMessage(A,"system_mysharecallback"),setTimeout(()=>s.sendMessage(A,"system_claimhangupreward"),200),setTimeout(()=>s.sendMessage(A,"system_mysharecallback",{isSkipShareCard:!0,type:2}),400),setTimeout(()=>s.sendMessage(A,"role_getroleinfo"),600),setTimeout(()=>{a.success("挂机奖励领取完成"),l.value.isClaiming=!1},1200)}catch(k){a.error("领取挂机奖励失败: "+((k==null?void 0:k.message)||"未知错误")),l.value.isClaiming=!1}};return(A,k)=>(d(),ce(Me,{class:"hang-up",statusClass:{active:l.value.isActive}},{icon:m(()=>[...k[0]||(k[0]=[e("img",{src:Eo,alt:"挂机图标"},null,-1)])]),title:m(()=>[k[1]||(k[1]=e("h3",null,"挂机时间",-1)),e("p",null,"已挂机："+f(_(l.value.elapsedTime)),1)]),badge:m(()=>[e("span",null,f(l.value.isActive?"挂机中":"已完成"),1)]),default:m(()=>[e("div",Po,f(_(l.value.remainingTime)),1)]),action:m(()=>[e("button",{class:"action-button secondary",disabled:l.value.isExtending,onClick:$},[l.value.isExtending?(d(),g("span",Oo,[...k[2]||(k[2]=[e("i",{class:"line-md:loading-loop"},null,-1),V(" 加钟中... ",-1)])])):(d(),g("span",Lo,"加钟"))],8,Ho),e("button",{class:"action-button primary",disabled:l.value.isClaiming,onClick:S},[l.value.isClaiming?(d(),g("span",jo,[...k[3]||(k[3]=[e("i",{class:"line-md:loading-loop"},null,-1),V(" 领取中... ",-1)])])):(d(),g("span",Go,"领取奖励"))],8,Fo)]),_:1},8,["statusClass"]))}},Vo=he(qo,[["__scopeId","data-v-491764b8"]]),Fe="/icons/1736425783912140.png",Qo={key:0},Jo={key:1},Ko={class:"monthly-row"},Yo={class:"row-value"},Xo={class:"monthly-row"},Zo={class:"row-value"},el={class:"action-row"},tl=["disabled"],be=320,we=240,sl={__name:"MonthlyTasksCard",setup(J,{expose:s}){const a=fe(),o=ge(),l=G(!1),_=G(!1),T=G(!1),B=G(null),$=new Date,S=new Date($.getFullYear(),$.getMonth()+1,0).getDate(),A=$.getDate(),k=I(()=>Math.max(0,S-A)),R=I(()=>Math.min(1,Math.max(0,A/S))),h=I(()=>{var p;return((p=B.value)==null?void 0:p.myMonthInfo)||{}}),y=I(()=>{var p;return((p=B.value)==null?void 0:p.myArenaInfo)||{}}),E=I(()=>{var p,c;return Number(((c=(p=h.value)==null?void 0:p["2"])==null?void 0:c.num)||0)}),q=I(()=>{var p;return Number(((p=y.value)==null?void 0:p.num)||0)}),D=I(()=>Math.min(100,Math.round(E.value/be*100))),C=I(()=>Math.min(100,Math.round(q.value/we*100))),v=I(()=>k.value===0?be:Math.min(be,Math.ceil(R.value*be))),b=I(()=>k.value===0?we:Math.min(we,Math.ceil(R.value*we))),x=[{label:"一键完成",key:"complete-fish"}],z=[{label:"一键完成",key:"complete-arena"}],U=I(()=>a.selectedToken?a.getWebSocketStatus(a.selectedToken.id)==="connected":!1),O=async()=>{var p;if(!a.selectedToken)return o.warning("请先选择Token");if(U.value){l.value=!0;try{const c=a.selectedToken.id,j=await a.sendMessageWithPromise(c,"activity_get",{},1e4),Y=(j==null?void 0:j.activity)||((p=j==null?void 0:j.body)==null?void 0:p.activity)||j;B.value=Y||null,Y&&o.success("月度任务进度已更新")}catch(c){o.error(`获取月度任务失败：${c.message}`)}finally{l.value=!1}}},le=()=>{const p=new Date;return p.setHours(0,0,0,0),Math.floor(p.getTime()/1e3)},ie=p=>!p||typeof p!="number"?!0:p<le(),Z=p=>{const c=p==="fish",j=c?be:we,Y=c?E.value:q.value,X=c?v.value:b.value,ee=Math.max(0,X-Y);return ee<=0?o.success("当前进度已达标，无需补齐"):c?P(ee,X,j):i(ee,X,j)},L=p=>{const c=p==="fish",j=c?be:we,Y=c?E.value:q.value,X=Math.max(0,j-Y);return X<=0?o.success("已满额，无需完成"):c?P(X,j,j):i(X,j,j)},ae=p=>{p==="complete-fish"&&L("fish")},Q=p=>{p==="complete-arena"&&L("arena")},P=async(p,c,j)=>{var Y,X,ee,N,K;if(!a.selectedToken)return o.warning("请先选择Token");if(!U.value)return o.warning("请先建立WS连接");_.value=!0;try{const ue=a.selectedToken.id;let ve=(X=(Y=a.gameData)==null?void 0:Y.roleInfo)==null?void 0:X.role;if(!ve){try{await a.sendGetRoleInfo(ue)}catch{}ve=(N=(ee=a.gameData)==null?void 0:ee.roleInfo)==null?void 0:N.role}let _e=0;const r=Number(((K=ve==null?void 0:ve.statisticsTime)==null?void 0:K["artifact:normal:lottery:time"])||0);if(ie(r)){o.info("检测到今日免费钓鱼次数，开始消耗 3 次");for(let w=0;w<3;w++)try{await a.sendMessageWithPromise(ue,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},8e3),_e++,await new Promise(M=>setTimeout(M,500))}catch{break}_e>0&&await O()}let n=Math.max(0,c-E.value);if(n<=0)return o.success("已通过免费次数完成当日目标");for(o.info(`开始付费钓鱼补齐：共需 ${n} 次（每次最多10）`);n>0;){const w=Math.min(10,n);try{await a.sendMessageWithPromise(ue,"artifact_lottery",{lotteryNumber:w,newFree:!0,type:1},12e3)}catch(M){o.error(`钓鱼失败：${M.message}`);break}n-=w,await new Promise(M=>setTimeout(M,800))}await O(),E.value>=c||E.value>=j?o.success("钓鱼补齐完成"):o.warning("钓鱼补齐已停止，未达到目标")}finally{_.value=!1}},i=async(p,c,j)=>{var Y,X,ee,N,K,ue;if(!a.selectedToken)return o.warning("请先选择Token");if(!U.value)return o.warning("请先建立WS连接");T.value=!0;try{const ve=a.selectedToken.id;try{await a.sendMessageWithPromise(ve,"arena_startarea",{},6e3)}catch{}let _e=0;const r=100;let n=1,w=p;for(;w>0&&_e<r;){const M=Math.ceil(w/2);o.info(`竞技场补齐 第${n}轮：计划战斗 ${M} 场（估算每胜+2）`);for(let H=0;H<M&&_e<r;H++){let F;try{F=await a.sendMessageWithPromise(ve,"arena_getareatarget",{refresh:!1},8e3)}catch{try{F=await a.sendMessageWithPromise(ve,"arena_getareatarget",{refresh:!0},8e3)}catch(W){o.error(`获取竞技场目标失败：${W.message}`);break}}const oe=((X=(Y=F==null?void 0:F.roleList)==null?void 0:Y[0])==null?void 0:X.roleId)||((N=(ee=F==null?void 0:F.targets)==null?void 0:ee[0])==null?void 0:N.roleId)||((ue=(K=F==null?void 0:F.targets)==null?void 0:K[0])==null?void 0:ue.id);if(!oe){o.warning("未找到可用的竞技场目标，已停止此轮");break}try{await a.sendMessageWithPromise(ve,"fight_startareaarena",{targetId:oe},15e3)}catch(W){o.error(`竞技场对决失败：${W.message}`)}_e++,await new Promise(W=>setTimeout(W,1200))}await O(),w=Math.max(0,c-q.value),n++}q.value>=c||q.value>=j?o.success("竞技场补齐完成"):_e>=r?o.warning("达到安全上限，已停止竞技场补齐"):o.warning("竞技场补齐已停止，未达到目标")}finally{T.value=!1}},t=G(!1);return me(()=>a.selectedToken?a.getWebSocketStatus(a.selectedToken.id):"disconnected",p=>{p==="connected"&&!t.value&&(t.value=!0,O())},{immediate:!0}),ke(()=>{a.selectedToken&&U.value&&O()}),s({fetchMonthlyActivity:O}),(p,c)=>{const j=te("n-button"),Y=te("n-dropdown"),X=te("n-button-group");return d(),ce(Me,{class:"monthly-tasks",statusClass:B.value?"active":""},{icon:m(()=>[...c[2]||(c[2]=[e("img",{src:Fe,alt:"月度任务"},null,-1)])]),title:m(()=>[...c[3]||(c[3]=[e("h3",null,"月度任务",-1),e("p",null,"进度与一键补齐",-1)])]),badge:m(()=>[k.value>0?(d(),g("span",Qo,"剩余 "+f(k.value)+" 天",1)):(d(),g("span",Jo,"本月最后一天"))]),default:m(()=>[e("div",Ko,[c[4]||(c[4]=e("div",{class:"row-title"},"钓鱼进度",-1)),e("div",Yo,f(E.value)+" / "+f(be)+"（"+f(D.value)+"%）",1)]),e("div",Xo,[c[5]||(c[5]=e("div",{class:"row-title"},"竞技场进度",-1)),e("div",Zo,f(q.value)+" / "+f(we)+"（"+f(C.value)+"%）",1)]),e("div",el,[e("button",{class:"action-button secondary",disabled:l.value||_.value||T.value,onClick:O},f(l.value?"刷新中...":"刷新进度"),9,tl),u(X,null,{default:m(()=>[u(j,{class:"action-button",disabled:l.value||_.value,onClick:c[0]||(c[0]=ee=>Z("fish"))},{default:m(()=>[V(f(_.value?"补齐中...":"钓鱼补齐"),1)]),_:1},8,["disabled"]),u(Y,{options:x,trigger:"click",onSelect:ae},{default:m(()=>[u(j,{disabled:l.value||_.value},{default:m(()=>[...c[6]||(c[6]=[V("▾",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1}),u(X,null,{default:m(()=>[u(j,{class:"action-button",disabled:l.value||T.value,onClick:c[1]||(c[1]=ee=>Z("arena"))},{default:m(()=>[V(f(T.value?"补齐中...":"竞技场补齐"),1)]),_:1},8,["disabled"]),u(Y,{options:z,trigger:"click",onSelect:Q},{default:m(()=>[u(j,{disabled:l.value||T.value},{default:m(()=>[...c[7]||(c[7]=[V("▾",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),e("p",{class:"description muted"}," 补齐规则：让“当前天数比例”和“完成比例”一致；若无剩余天数则按满额（"+f(be)+"/"+f(we)+"）计算。 ")]),_:1},8,["statusClass"])}}},nl=he(sl,[["__scopeId","data-v-77b18c56"]]),al={__name:"StudyChallengeCard",setup(J){const s=fe(),a=ge(),o=I(()=>s.gameData.studyStatus),l=async()=>{if(!s.selectedToken||o.value.thisWeek||o.value.status!=""&&o.value.status!="idel")return;console.log("开始答题",o.value),o.value.status="starting",await Ke(),o.value.status="answering";const _=await Ye();if(a.info(`🚀 开始一键答题... (题库包含 ${_} 道题目)`),o.value.isCompleted)return a.success("✅ 咸鱼大冲关任务已完成，无需重复作答！");try{s.gameData.studyStatus={...s.gameData.studyStatus,isAnswering:!0,questionCount:0,answeredCount:0,status:"starting",timestamp:Date.now()};const T=s.selectedToken.id;s.sendMessage(T,"study_startgame"),setTimeout(()=>{s.gameData.studyStatus.isAnswering&&(s.gameData.studyStatus={...s.gameData.studyStatus,isAnswering:!1,questionCount:0,answeredCount:0,status:"",timestamp:null},a.warning("答题超时，已自动重置状态"))},4e4),a.info(`🚀 开始一键答题... (题库包含 ${_} 道题目)`)}catch(T){console.error("启动答题失败:",T),a.error("启动答题失败: "+T.message)}};return(_,T)=>{const B=Le;return d(),ce(Me,{class:"study",statusClass:{weekly:!0,completed:o.value.isCompleted}},{icon:m(()=>[...T[0]||(T[0]=[e("img",{src:Fe,alt:"学习图标"},null,-1)])]),title:m(()=>[...T[1]||(T[1]=[e("h3",null,"咸鱼大冲关",-1),e("p",null,"每日知识挑战",-1)])]),badge:m(()=>[...T[2]||(T[2]=[e("span",null,"每周任务",-1)])]),default:m(()=>[...T[3]||(T[3]=[e("p",{class:"description"},"没有什么可以阻挡我求知的欲望！",-1)])]),action:m(()=>[o.value.thisWeek?se("",!0):(d(),ce(B,{key:0,status:"primary",onClick:l},{default:m(()=>[...T[4]||(T[4]=[V(" 🎯 一键答题. ",-1)])]),_:1})),!o.value.thisWeek&&o.value.status=="starting"?(d(),ce(B,{key:1,status:"warning",disabled:!0},{default:m(()=>[...T[5]||(T[5]=[V(" 正在获取题库... ",-1)])]),_:1})):se("",!0),!o.value.thisWeek&&o.value.status=="answering"?(d(),ce(B,{key:2,status:"warning",disabled:!0},{default:m(()=>[...T[6]||(T[6]=[V(" 答题中... ",-1)])]),_:1})):se("",!0),!o.value.thisWeek&&o.value.status=="claiming_rewards"?(d(),ce(B,{key:3,status:"warning",disabled:!0},{default:m(()=>[...T[7]||(T[7]=[V(" 正在领取奖励... ",-1)])]),_:1})):se("",!0),!o.value.thisWeek&&o.value.status=="completed"?(d(),ce(B,{key:4,status:"warning",disabled:!0},{default:m(()=>[...T[8]||(T[8]=[V(" 答题完成 ",-1)])]),_:1})):se("",!0),o.value.thisWeek?(d(),ce(B,{key:5,status:"success",disabled:!0},{default:m(()=>[...T[9]||(T[9]=[V(" ✅ 已完成无需作答 ",-1)])]),_:1})):se("",!0)]),_:1},8,["statusClass"])}}},ol={class:"game-status-container"},ll={__name:"GameStatus",setup(J){const s=fe();ge();const a=G({isRegistered:!1});G(!1);const o=G("daily");I(()=>{const R=new Date().getDay();return R>=1&&R<=3});const l=G({isRunning:!1,remainingTime:0,stopTime:0}),_=G({isActive:!1,remainingTime:0,elapsedTime:0,lastTime:0,hangUpTime:0,isExtending:!1,isClaiming:!1}),T=G({isSignedIn:!1,clubName:""});I(()=>s.gameData.studyStatus);const B=I(()=>{var R;return((R=s.gameData)==null?void 0:R.roleInfo)||null});I(()=>s.selectedToken?s.getWebSocketStatus(s.selectedToken.id)==="connected":!1);const $=()=>{if(!B.value)return;const R=B.value.role;if(R.bottleHelpers){const h=Date.now()/1e3;l.value.stopTime=R.bottleHelpers.helperStopTime,l.value.isRunning=R.bottleHelpers.helperStopTime>h,l.value.remainingTime=Math.max(0,Math.floor(R.bottleHelpers.helperStopTime-h))}if(R.hangUp){const h=Date.now()/1e3;_.value.lastTime=R.hangUp.lastTime,_.value.hangUpTime=R.hangUp.hangUpTime;const y=h-_.value.lastTime;y<=_.value.hangUpTime?(_.value.remainingTime=Math.floor(_.value.hangUpTime-y),_.value.isActive=!0):(_.value.remainingTime=0,_.value.isActive=!1),_.value.elapsedTime=Math.floor(_.value.hangUpTime-_.value.remainingTime)}if(R.statistics){const h=new Date;h.setHours(0,0,0,0);const y=h.getTime()/1e3;a.value.isRegistered=Number(R.statistics["last:legion:match:sign:up:time"])>y}if(R.statisticsTime){const h=new Date;h.setHours(0,0,0,0);const y=h.getTime()/1e3;T.value.isSignedIn=R.statisticsTime["legion:sign:in"]>y}};let S=null;const A=()=>{S&&clearInterval(S),S=setInterval(()=>{l.value.isRunning&&l.value.remainingTime>0&&(l.value.remainingTime=Math.max(0,l.value.remainingTime-1),l.value.remainingTime<=0&&(l.value.isRunning=!1)),_.value.isActive&&_.value.remainingTime>0&&(_.value.remainingTime=Math.max(0,_.value.remainingTime-1),_.value.elapsedTime=_.value.elapsedTime+1,_.value.remainingTime<=0&&(_.value.isActive=!1))},1e3)};me(B,R=>{R&&$()},{deep:!0,immediate:!0});const k=G(!1);return me(()=>s.selectedToken?s.getWebSocketStatus(s.selectedToken.id):"disconnected",R=>{if(R==="connected"&&!k.value&&s.selectedToken){k.value=!0;const h=s.selectedToken.id;s.sendMessage(h,"legion_getinfo")}}),ke(()=>{if($(),A(),s.selectedToken&&s.getWebSocketStatus(s.selectedToken.id)==="connected"){const R=s.selectedToken.id;s.sendMessage(R,"legion_getinfo"),k.value=!0}}),xe(()=>{S&&clearInterval(S)}),(R,h)=>{const y=zo,E=te("n-tab-pane"),q=te("n-tabs"),D=Za,C=Ra,v=ta,b=Fn,x=Jt;return d(),g("div",ol,[u(y,{embedded:""}),u(q,{class:"section-tabs",value:o.value,"onUpdate:value":h[0]||(h[0]=z=>o.value=z),type:"line",animated:"",size:"small"},{default:m(()=>[u(E,{name:"daily",tab:"日常"}),u(E,{name:"club",tab:"俱乐部"}),u(E,{name:"activity",tab:"活动"})]),_:1},8,["value"]),$e(u(D,null,null,512),[[Te,o.value==="daily"]]),$e(u(C,null,null,512),[[Te,o.value==="daily"]]),$e(u(v,null,null,512),[[Te,o.value==="daily"]]),$e(u(Bo,null,null,512),[[Te,o.value==="daily"]]),$e(u(Vo,null,null,512),[[Te,o.value==="daily"]]),se("",!0),se("",!0),o.value==="club"?(d(),ce(b,{key:2})):se("",!0),o.value==="club"?(d(),ce(x,{key:3})):se("",!0),$e(u(nl,null,null,512),[[Te,o.value==="activity"]]),$e(u(al,null,null,512),[[Te,o.value==="activity"]])])}}},il=he(ll,[["__scopeId","data-v-846adb47"]]),rl={class:"game-features-page"},cl={class:"page-header"},ul={class:"container"},dl={class:"header-content"},ml={class:"header-left"},vl={class:"page-subtitle"},pl={class:"header-actions"},fl={key:0,class:"feedback-section"},_l={class:"features-grid-section"},gl={class:"container"},hl={class:"ws-status-section"},yl={class:"container"},kl={class:"ws-status-card"},bl={class:"status-header"},wl={class:"status-content"},$l={class:"status-item"},Tl={key:0,class:"status-item"},Cl={key:1,class:"status-item"},Sl={__name:"GameFeatures",setup(J){const s=Xe(),a=ge(),o=fe(),l=G(!0),_=G(null),T=I(()=>o.selectedToken&&o.getWebSocketStatus(o.selectedToken.id)==="connected"?"connected":"disconnected"),B=I(()=>o.selectedToken?o.getWebSocketStatus(o.selectedToken.id)==="connected"?"已连接":"未连接":"未选择Token"),$=I(()=>T.value==="connected"?"status-connected":"status-disconnected"),S=I(()=>T.value==="connected"),A=()=>{if(!o.selectedToken){a.warning("请先选择一个Token"),s.push("/tokens");return}try{const y=o.selectedToken.id,E=o.selectedToken.token;o.createWebSocketConnection(y,E),a.info("正在建立 WebSocket 连接..."),setTimeout(async()=>{o.getWebSocketStatus(y)==="connected"&&(a.success("WebSocket 连接成功"),await h())},2e3)}catch(y){console.error("WebSocket连接失败:",y),a.error("WebSocket连接失败")}},k=()=>{if(o.selectedToken){const y=o.selectedToken.id;o.closeWebSocketConnection(y),a.info("WebSocket连接已断开")}},R=()=>{T.value==="connected"?k():A()};ke(()=>{o.selectedToken&&(o.getWebSocketStatus(o.selectedToken.id)!=="connected"?A():h())}),me(()=>{if(!o.selectedToken)return{status:"disconnected",lastError:null};const y=o.wsConnections[o.selectedToken.id];return{status:y==null?void 0:y.status,lastError:y==null?void 0:y.lastError}},y=>{if(y&&y.status==="error"&&y.lastError){const E=String(y.lastError.error||"").toLowerCase();E.includes("token")&&E.includes("expired")&&(a.error("当前 Token 已过期，请重新导入后再试"),s.push("/tokens"))}},{deep:!0});const h=async()=>{if(o.selectedToken)try{const y=o.selectedToken.id;o.sendMessage(y,"role_getroleinfo"),o.sendMessage(y,"tower_getinfo"),o.sendMessage(y,"presetteam_getinfo")}catch{}};return xe(()=>{}),(y,E)=>{var v;const q=te("n-icon"),D=il,C=te("n-button");return d(),g("div",rl,[e("div",cl,[e("div",ul,[e("div",dl,[e("div",ml,[E[0]||(E[0]=e("h1",{class:"page-title"}," 游戏功能 ",-1)),e("p",vl,f(((v=ne(o).selectedToken)==null?void 0:v.name)||"未选择Token"),1)]),e("div",pl,[e("div",{class:de(["connection-status",T.value])},[u(q,null,{default:m(()=>[u(ne(vt))]),_:1}),e("span",null,f(B.value),1)],2)])])])]),l.value?(d(),g("div",fl)):se("",!0),e("div",_l,[e("div",gl,[u(D)])]),e("div",hl,[e("div",yl,[e("div",kl,[e("div",bl,[E[1]||(E[1]=e("h3",null,"连接状态",-1)),u(C,{text:"",onClick:R},{default:m(()=>[V(f(S.value?"断开连接":"重新连接"),1)]),_:1})]),e("div",wl,[e("div",$l,[E[2]||(E[2]=e("span",null,"WebSocket状态:",-1)),e("span",{class:de($.value)},f(B.value),3)]),ne(o).selectedToken?(d(),g("div",Tl,[E[3]||(E[3]=e("span",null,"当前Token:",-1)),e("span",null,f(ne(o).selectedToken.name),1)])):se("",!0),_.value?(d(),g("div",Cl,[E[4]||(E[4]=e("span",null,"最后活动:",-1)),e("span",null,f(_.value),1)])):se("",!0)])])])])])}}},Ul=he(Sl,[["__scopeId","data-v-cdd77b84"]]);export{Ul as default};
